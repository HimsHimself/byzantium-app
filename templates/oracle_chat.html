{% extends "index.html" %}

{% block content %}
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>

    <style>
        /* Custom styles for Markdown elements within chat messages */
        .oracle-message-content pre, .oracle-message-content code {
            font-family: 'Courier New', Courier, monospace; /* Consistent monospaced font */
        }

        .oracle-message-content pre {
            background-color: #282c34; /* Default for atom-one-dark, adjust if changing theme */
            color: #abb2bf;
            padding: 1em;
            border-radius: 0.375rem; /* Tailwind's rounded-md */
            overflow-x: auto;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .oracle-message-content pre code {
          background-color: transparent; /* Code inside pre should be transparent */
          padding: 0;
        }
        /* Inline code */
        .oracle-message-content code:not(pre > code) {
            background-color: #e2e8f0; /* Tailwind's gray-200 */
            color: #4a5568; /* Tailwind's gray-700 */
            padding: 0.125em 0.25em;
            border-radius: 0.25rem; /* Tailwind's rounded-sm */
            font-size: 0.9em;
        }

        .oracle-message-content table {
            width: auto; /* Or '100%' for full width within bubble */
            border-collapse: collapse;
            margin-top: 1em;
            margin-bottom: 1em;
            border: 1px solid #cbd5e1; /* Tailwind's slate-300 */
        }
        .oracle-message-content th, .oracle-message-content td {
            border: 1px solid #cbd5e1; /* Tailwind's slate-300 */
            padding: 0.5em;
            text-align: left;
        }
        .oracle-message-content th {
            background-color: #f1f5f9; /* Tailwind's slate-100 */
        }
        .oracle-message-content ul, .oracle-message-content ol {
            margin-left: 1.5rem; /* Indent lists */
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .oracle-message-content li {
            margin-bottom: 0.25em;
        }
        .oracle-message-content blockquote {
            border-left: 4px solid #a78bfa; /* Tailwind's purple-400 */
            padding-left: 1rem;
            margin-left: 0;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            font-style: italic;
            color: #5b21b6; /* Tailwind's purple-700 */
        }
        .oracle-message-content h1, .oracle-message-content h2, .oracle-message-content h3, .oracle-message-content h4 {
            margin-top: 0.75em;
            margin-bottom: 0.25em;
            font-weight: 600; /* semibold */
        }
        .oracle-message-content h1 { font-size: 1.5em; } /* Adjust as needed */
        .oracle-message-content h2 { font-size: 1.25em; }
        .oracle-message-content h3 { font-size: 1.1em; }
    </style>
</head>

<div class="content-card rounded-lg p-4 md:p-6 h-full flex flex-col">
    ```

## Step 2: Update the JavaScript Logic

In your existing `<script>` tag at the bottom of `oracle_chat.html`, make the following changes:

1.  **Initialize Showdown converter:**
2.  **Modify `appendMessage` function:**
    * For messages from "The Oracle", convert `messageText` from Markdown to HTML using Showdown.
    * Set `messageP.innerHTML` instead of `messageP.textContent` for these messages.
    * After appending the message, find all `<pre><code>` blocks within it and apply `hljs.highlightElement()`.

Here's the updated JavaScript section:

```javascript
<script>
    const chatMessagesDiv = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const userMessageInput = document.getElementById('user-message');
    const sendButton = document.getElementById('send-button');
    const sendButtonText = document.getElementById('send-button-text');
    const loadingSpinner = document.getElementById('loading-spinner');

    let chatHistory = []; // Session-only history

    // Initialize Showdown converter
    const converter = new showdown.Converter({
        tables: true,                         // Enable table rendering
        strikethrough: true,                  // Enable strikethrough
        tasklists: true,                      // Enable task lists e.g., - [x]
        simpleLineBreaks: true,               // Convert single newlines to <br>
        ghCompatibleHeaderId: true,           // Generate GitHub-compatible header IDs
        openLinksInNewWindow: true,           // Open links in new tabs
        emoji: true                           // Enable emoji conversion like :D
    });

    function appendMessage(sender, messageText, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('p-3', 'rounded-lg', 'max-w-xl', 'text-sm', 'shadow', 'break-words');
        
        const senderP = document.createElement('p');
        senderP.classList.add('font-semibold', 'mb-1');
        senderP.textContent = sender;

        const messageContentDiv = document.createElement('div'); // Use a div for content

        if (isUser) {
            messageDiv.classList.add('bg-blue-100', 'text-blue-800', 'self-end', 'ml-auto');
            messageContentDiv.textContent = messageText; // User messages are plain text
        } else {
            messageDiv.classList.add('bg-purple-100', 'text-purple-800', 'self-start');
            // Add a specific class for Oracle messages to target with CSS for markdown elements
            messageContentDiv.classList.add('oracle-message-content'); 
            const htmlContent = converter.makeHtml(messageText); // Convert Oracle's message from Markdown
            messageContentDiv.innerHTML = htmlContent; // Set as HTML
        }
        
        messageDiv.appendChild(senderP);
        messageDiv.appendChild(messageContentDiv); // Append content div
        chatMessagesDiv.appendChild(messageDiv);

        // Apply syntax highlighting to Oracle's messages after HTML is inserted
        if (!isUser) {
            messageContentDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }

    chatForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        const userText = userMessageInput.value.trim();
        if (!userText) return;

        appendMessage('You', userText, true);
        const historyForApi = [...chatHistory]; 
        chatHistory.push({ role: 'user', parts: [{ text: userText }] });
        userMessageInput.value = '';
        
        sendButton.disabled = true;
        sendButtonText.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');

        try {
            const response = await fetch("{{ url_for('api_oracle_chat_query') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    message: userText, 
                    history: historyForApi
                })
            });

            sendButton.disabled = false;
            sendButtonText.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            userMessageInput.focus();

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({error: "Failed to parse error response."}));
                throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            appendMessage('The Oracle', data.reply); // This will now be rendered as Markdown
            chatHistory.push({ role: 'model', parts: [{ text: data.reply }] });

        } catch (error) {
            console.error('Error sending message:', error);
            // Use the same styling for system error messages as Oracle messages for consistency, but don't process markdown
            const errorText = 'Error: Could not get a response. ' + error.message;
            
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('p-3', 'rounded-lg', 'max-w-xl', 'text-sm', 'shadow', 'break-words', 'bg-red-100', 'text-red-800', 'self-start');
            const senderP = document.createElement('p');
            senderP.classList.add('font-semibold', 'mb-1');
            senderP.textContent = 'System';
            const messageP = document.createElement('p');
            messageP.textContent = errorText;
            messageDiv.appendChild(senderP);
            messageDiv.appendChild(messageP);
            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }
    });

    // Ensure highlight.js is initialized after the page loads if you load specific languages and it doesn't auto-init
    // hljs.highlightAll(); // Or call highlightElement on dynamic content as done in appendMessage
</script>
{% endblock %}