{% extends "index.html" %}
{% import '_macros.html' as macros with context %}

{% macro render_tree(items, is_root, current_note_id) %}
<ul class="space-y-0.5 {{ 'pl-4' if not is_root else '' }}">
    {% for item in items %}
        {% if 'children' in item %} {# It's a folder #}
            <li class="tree-item">
                <details {{ 'open' if current_note and current_note.folder_id and item.id == current_note.folder_id else '' }}>
                    <summary class="group flex justify-between items-center px-1 py-0.5 rounded-md hover:bg-slate-200 cursor-pointer">
                        <div class="flex items-center gap-1.5 flex-grow truncate">
                            <svg class="w-4 h-4 text-amber-600 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.5 21a3 3 0 003-3v-9a3 3 0 00-3-3h-6.879a.75.75 0 01-.53-.22L11.53 5.22a.75.75 0 00-.53-.22H4.5a3 3 0 00-3 3v12a3 3 0 003 3h15z" /></svg>
                            <span class="text-sm font-medium text-slate-700 truncate">{{ item.name }}</span>
                        </div>
                        <div class="flex items-center shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                            <a href="#" onclick="toggleAddForm('add-note-form-{{ item.id }}', event)" title="Add Note" class="p-0.5 text-slate-500 hover:text-purple-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            </a>
                            <form action="{{ url_for('delete_folder', folder_id=item.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this folder and all its contents?');" class="p-0.5">
                                <button type="submit" class="text-slate-500 hover:text-red-600" title="Delete Folder">
                                    {{ macros.delete_icon(classes='w-4 h-4') }}
                                </button>
                            </form>
                        </div>
                    </summary>
                    <div id="add-note-form-{{ item.id }}" class="hidden pl-4 pt-1">
                        <form method="POST" action="{{ url_for('add_note') }}" class="flex gap-2">
                             <input type="hidden" name="folder_id" value="{{ item.id }}">
                            <input type="text" name="note_title" placeholder="New Note Title..." required class="form-input flex-grow p-1 text-sm rounded-md">
                            <button type="submit" class="btn-primary text-xs px-2 rounded-md shrink-0">Add</button>
                        </form>
                    </div>
                    {{ render_tree(item.children, false, current_note_id) }}
                    {{ render_tree(item.notes, false, current_note_id) }}
                </details>
            </li>
        {% else %} {# It's a note #}
            <li data-note-id="{{ item.id }}" class="tree-item group flex justify-between items-center px-1 py-0.5 rounded-md {% if current_note_id and current_note_id == item.id %}active{% else %}hover:bg-slate-200{% endif %}">
                <a href="{{ url_for('view_note', note_id=item.id) }}" class="flex items-center gap-1.5 flex-grow truncate pr-2">
                     <svg class="w-4 h-4 text-slate-500 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0016.5 9h-1.875a.375.375 0 01-.375-.375V6.75A3.75 3.75 0 0010.5 3h-4.875A1.875 1.875 0 005.625 1.5z" clip-rule="evenodd" /></svg>
                    <span class="text-sm font-medium truncate">{{ item.title }}</span>
                </a>
                <button type="button" data-note-id="{{ item.id }}" class="delete-note-btn shrink-0 opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-red-600 p-0.5 rounded-full">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </li>
        {% endif %}
    {% endfor %}
</ul>
{% endmacro %}


{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.5.1/github-markdown.min.css">
<style>
    .notes-container { display: flex; gap: 1.5rem; height: calc(100vh - 120px); }
    .notes-explorer {
        flex: 0 0 24rem; background-color: #f8fafc; border-radius: 0.75rem;
        padding: 1rem; overflow-y: auto; border: 1px solid var(--byzantine-border);
        display: flex; flex-direction: column;
    }
    .explorer-content { flex-grow: 1; }
    .notes-editor-pane { flex: 1 1 auto; display: flex; flex-direction: column; min-width: 0; }
    .tree-item a { color: var(--byzantine-slate); }
    .tree-item a:hover { color: var(--imperial-purple); }
    .tree-item.active { background-color: #eef2ff; }
    .tree-item.active a { color: var(--imperial-purple); font-weight: 600; }
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
    details > summary::before { content: 'â–º'; font-size: 0.6em; margin-right: 0.25rem; transition: transform 0.2s; display: inline-block; vertical-align: middle; }
    details[open] > summary::before { transform: rotate(90deg); }
    .tribute-container li { padding: 0.5rem 1rem; cursor: pointer; }
    .tribute-container li.highlight, .tribute-container li:hover { background-color: #f4f2f7; color: var(--imperial-purple, #4B0082); }
    .editor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; flex-grow: 1; min-height: 0; }
    .markdown-body { padding: 1rem; overflow-y: auto; }
</style>

<div class="notes-container">

    <div class="notes-explorer">
        <div class="explorer-content">
            <h2 class="text-lg font-semibold text-slate-800 mb-2">Scribe's Desk</h2>
            {{ render_tree(notes_tree, true, current_note.id if current_note else None) }}

            {% if orphaned_notes %}
            <div class="pt-2 mt-2 border-t border-slate-200">
                <h3 class="text-xs font-semibold uppercase text-slate-500 my-2">Orphaned Notes</h3>
                {{ render_tree(orphaned_notes, true, current_note.id if current_note else None) }}
            </div>
            {% endif %}
        </div>
        <div class="mt-4 pt-4 border-t border-slate-200 space-y-3">
             <form method="POST" action="{{ url_for('add_folder') }}" class="flex gap-2">
                <input type="hidden" name="parent_folder_id" value="">
                <input type="text" name="folder_name" placeholder="New Root Folder..." required class="form-input flex-grow p-2 text-sm rounded-md">
                <button type="submit" class="btn-primary text-sm px-3 py-2 rounded-md shrink-0">Add</button>
            </form>
             <form method="POST" action="{{ url_for('add_note') }}" class="flex gap-2">
                 <input type="hidden" name="folder_id" value="">
                <input type="text" name="note_title" placeholder="New Orphaned Note..." required class="form-input flex-grow p-2 text-sm rounded-md">
                <button type="submit" class="btn-primary text-sm px-3 py-2 rounded-md shrink-0">Create</button>
            </form>
        </div>
    </div>

    <div class="notes-editor-pane">
        {% if current_note %}
            <div class="flex flex-col h-full bg-white rounded-lg border border-slate-200 shadow-sm">
                <form id="note-editor-form" method="POST" action="{{ url_for('update_note', note_id=current_note.id) }}" class="flex items-center gap-4 p-3 border-b border-slate-200">
                    <input type="text" name="note_title" value="{{ current_note.title }}" class="form-input text-xl font-bold flex-grow p-2 border-transparent focus:border-slate-300 focus:ring-0">
                    <button type="submit" class="btn-primary font-semibold py-2 px-6 rounded-md shrink-0">Save</button>
                </form>
                
                <div class="editor-grid p-2">
                    <textarea form="note-editor-form" id="note_content" name="note_content" class="w-full h-full p-4 text-sm resize-none border rounded-md focus:ring-purple-500 focus:border-purple-500" style="color: #334155; font-family: 'Fira Code', 'Consolas', monospace;">{{ content_for_editing if content_for_editing is not none else '' }}</textarea>
                    <div id="note-preview" class="markdown-body border rounded-md h-full"></div>
                </div>

                <div class="p-4 border-t border-slate-200 bg-slate-50 grid grid-cols-1 sm:grid-cols-2 gap-6 rounded-b-lg">
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2 text-sm">Linked From (Backlinks)</h4>
                        {% if backlinks %}<ul class="list-disc list-inside text-sm space-y-1">{% for link in backlinks %}<li><a href="{{ url_for('view_note', note_id=link.id) }}" class="text-purple-600 hover:underline">{{ link.title }}</a></li>{% endfor %}</ul>{% else %}<p class="text-sm text-slate-500 italic">No notes link here.</p>{% endif %}
                    </div>
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2 text-sm">Links To (Outgoing)</h4>
                        {% if outgoing_links %}<ul class="list-disc list-inside text-sm space-y-1">{% for link in outgoing_links %}<li><a href="{{ url_for('view_note', note_id=link.id) }}" class="text-purple-600 hover:underline">{{ link.title }}</a></li>{% endfor %}</ul>{% else %}<p class="text-sm text-slate-500 italic">No outgoing links.</p>{% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            <div class="flex items-center justify-center h-full text-center text-slate-500 bg-white rounded-lg border border-dashed">
                <div>
                    <svg class="w-12 h-12 mx-auto text-slate-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                    <h3 class="mt-2 text-sm font-semibold text-gray-900">Select a Note</h3>
                    <p class="mt-1 text-sm text-gray-500">Select a note from the tree to view it, or create a new one.</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.min.js"></script>
<script>
    function toggleAddForm(formId, event) {
        event.preventDefault();
        event.stopPropagation();
        const formDiv = document.getElementById(formId);
        if (formDiv) {
            formDiv.classList.toggle('hidden');
            if (!formDiv.classList.contains('hidden')) {
                formDiv.querySelector('input[type="text"]').focus();
            }
        }
    }

document.addEventListener('DOMContentLoaded', () => {
    const noteContentElement = document.getElementById('note_content');
    const notePreviewElement = document.getElementById('note-preview');
    let debounceTimer;

    function updatePreview() {
        const markdownText = noteContentElement.value;
        fetch('/api/render_markdown', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: markdownText })
        })
        .then(response => response.json())
        .then(data => {
            notePreviewElement.innerHTML = data.html;
        })
        .catch(err => console.error('Preview Error:', err));
    }

    if (noteContentElement && notePreviewElement) {
        // Initial render
        updatePreview();

        // Update on typing (with debounce)
        noteContentElement.addEventListener('keyup', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(updatePreview, 300);
        });
        
        // Tribute.js setup for [[links]]
        const tribute = new Tribute({
            trigger: '[[',
            values: (text, cb) => {
                if (text.length > 0) {
                    fetch(`/api/notes/search?q=${encodeURIComponent(text)}`).then(res => res.json())
                        .then(data => cb(data.map(t => ({ key: t, value: t }))))
                        .catch(() => cb([]));
                } else { cb([]); }
            },
            selectTemplate: item => `[[${item.original.value}]]`,
            allowSpaces: true,
        });
        tribute.attach(noteContentElement);
    }

    // AJAX Deletion
    document.querySelectorAll('.delete-note-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const noteId = button.dataset.noteId;
            if (confirm('Are you sure you want to delete this note?')) {
                fetch(`/api/note/${noteId}/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector(`li[data-note-id="${noteId}"]`)?.remove();
                        if (window.location.pathname.includes(`/note/${noteId}`)) {
                           window.location.href = "{{ url_for('notes_page') }}";
                        } else {
                           createToast('Note deleted.', 'success');
                        }
                    } else {
                        createToast('Error: ' + data.error, 'error');
                    }
                }).catch(() => createToast('A server error occurred.', 'error'));
            }
        });
    });
});
</script>
{% endblock %}