{% extends "index.html" %}
{% import '_macros.html' as macros with context %}

{% macro render_tree(items, is_root, current_note_id) %}
<ul class="space-y-0.5 {{ 'pl-4' if not is_root else '' }}">
    {% for item in items %}
        {% if 'children' in item %} {# It's a folder #}
            <li class="tree-item">
                <details {{ 'open' if current_note and current_note.folder_id and item.id == current_note.folder_id else '' }}>
                    <summary class="group flex justify-between items-center px-1 py-0.5 rounded-md hover:bg-slate-200 cursor-pointer">
                        <div class="flex items-center gap-1.5 flex-grow truncate">
                            <svg class="w-4 h-4 text-amber-600 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.5 21a3 3 0 003-3v-9a3 3 0 00-3-3h-6.879a.75.75 0 01-.53-.22L11.53 5.22a.75.75 0 00-.53-.22H4.5a3 3 0 00-3 3v12a3 3 0 003 3h15z" /></svg>
                            <span class="text-sm font-medium text-slate-700 truncate">{{ item.name }}</span>
                        </div>
                        <div class="flex items-center shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                            <a href="#" onclick="toggleAddForm('add-note-form-{{ item.id }}', event)" title="Add Note" class="p-0.5 text-slate-500 hover:text-purple-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            </a>
                            <form action="{{ url_for('delete_folder', folder_id=item.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this folder and all its contents?');" class="p-0.5">
                                <button type="submit" class="text-slate-500 hover:text-red-600" title="Delete Folder">
                                    {{ macros.delete_icon(classes='w-4 h-4') }}
                                </button>
                            </form>
                        </div>
                    </summary>
                    <div id="add-note-form-{{ item.id }}" class="hidden pl-4 pt-1">
                        <form method="POST" action="{{ url_for('add_note') }}" class="flex gap-2">
                             <input type="hidden" name="folder_id" value="{{ item.id }}">
                            <input type="text" name="note_title" placeholder="New Note Title..." required class="form-input flex-grow p-1 text-sm rounded-md">
                            <button type="submit" class="btn-primary text-xs px-2 rounded-md shrink-0">Add</button>
                        </form>
                    </div>
                    {{ render_tree(item.children, false, current_note_id) }}
                    {{ render_tree(item.notes, false, current_note_id) }}
                </details>
            </li>
        {% else %} {# It's a note #}
            <li data-note-id="{{ item.id }}" class="tree-item group flex justify-between items-center px-1 py-0.5 rounded-md {% if current_note_id and current_note_id == item.id %}active{% else %}hover:bg-slate-200{% endif %}">
                <a href="{{ url_for('view_note', note_id=item.id) }}" class="flex items-center gap-1.5 flex-grow truncate pr-2">
                     <svg class="w-4 h-4 text-slate-500 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0016.5 9h-1.875a.375.375 0 01-.375-.375V6.75A3.75 3.75 0 0010.5 3h-4.875A1.875 1.875 0 005.625 1.5z" clip-rule="evenodd" /></svg>
                    <span class="text-sm font-medium truncate">{{ item.title }}</span>
                </a>
                <button type="button" data-note-id="{{ item.id }}" class="delete-note-btn shrink-0 opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-red-600 p-0.5 rounded-full">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </li>
        {% endif %}
    {% endfor %}
</ul>
{% endmacro %}


{% block content %}
<style>
    .notes-container { display: flex; gap: 1.5rem; height: calc(100vh - 120px); }
    .notes-explorer {
        flex: 0 0 24rem; background-color: var(--color-surface); border-radius: 0.75rem;
        padding: 1rem; overflow-y: auto; border: 1px solid var(--color-border);
        display: flex; flex-direction: column;
    }
    .explorer-content { flex-grow: 1; }
    .notes-editor-pane { flex: 1 1 auto; display: flex; flex-direction: column; min-width: 0; }
    .tree-item a { color: var(--color-text-secondary); }
    .tree-item a:hover { color: var(--color-primary); }
    .tree-item.active { background-color: var(--color-primary-light); }
    .tree-item.active a { color: var(--color-primary); font-weight: 600; }
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
    details > summary::before { content: 'â–º'; font-size: 0.6em; margin-right: 0.25rem; transition: transform 0.2s; display: inline-block; vertical-align: middle; }
    details[open] > summary::before { transform: rotate(90deg); }
    /* Styling for the editor */
    .codex-editor__redactor { padding-bottom: 100px !important; }
    .ce-block__content, .ce-toolbar__content { max-width: 800px; }
</style>

<div class="notes-container">

    <aside class="notes-explorer">
        <div class="explorer-content">
            <h2 class="text-lg font-semibold text-slate-800 mb-2">Scribe's Desk</h2>
            {{ render_tree(notes_tree, true, current_note.id if current_note else None) }}

            {% if orphaned_notes %}
            <div class="pt-2 mt-2 border-t border-slate-200">
                <h3 class="text-xs font-semibold uppercase text-slate-500 my-2">Orphaned Notes</h3>
                {{ render_tree(orphaned_notes, true, current_note.id if current_note else None) }}
            </div>
            {% endif %}
        </div>
        <div class="mt-4 pt-4 border-t border-slate-200 space-y-3">
             <form method="POST" action="{{ url_for('add_folder') }}" class="flex gap-2">
                <input type="hidden" name="parent_folder_id" value="">
                <input type="text" name="folder_name" placeholder="New Root Folder..." required class="form-input flex-grow p-2 text-sm rounded-md">
                <button type="submit" class="btn-primary text-sm px-3 py-2 rounded-md shrink-0">Add Folder</button>
            </form>
             <form method="POST" action="{{ url_for('add_note') }}" class="flex gap-2">
                <input type="hidden" name="folder_id" value="">
                <input type="text" name="note_title" placeholder="New Note..." required class="form-input flex-grow p-2 text-sm rounded-md">
                <button type="submit" class="btn-primary text-sm px-3 py-2 rounded-md shrink-0">Create Note</button>
            </form>
        </div>
    </aside>

    <main class="notes-editor-pane"
          data-current-note-id="{{ current_note.id if current_note else '' }}"
          data-notes-url="{{ url_for('notes_page') }}"
          data-delete-url-template="{{ url_for('api_delete_note', note_id=0) }}">
        {% if current_note %}
            <div class="flex flex-col h-full bg-white rounded-lg border border-slate-200 shadow-sm">
                <div id="note-editor-form" action="{{ url_for('update_note', note_id=current_note.id) }}">
                    <div class="flex items-center gap-4 p-3 border-b border-slate-200">
                        <input type="text" name="note_title" value="{{ current_note.title }}" class="form-input text-xl font-bold flex-grow p-2 border-transparent focus:border-slate-300 focus:ring-0">
                        <button type="button" id="save-button" class="btn-primary font-semibold py-2 px-6 rounded-md shrink-0">Save</button>
                    </div>
                </div>
                
                <div id="editorjs" class="flex-grow p-4 overflow-y-auto">
                </div>

                <div class="p-4 border-t border-slate-200 bg-slate-50/50 grid grid-cols-1 sm:grid-cols-2 gap-6 rounded-b-lg">
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2 text-sm">Linked From (Backlinks)</h4>
                        {% if backlinks %}<ul class="list-disc list-inside text-sm space-y-1">{% for link in backlinks %}<li><a href="{{ url_for('view_note', note_id=link.id) }}" class="text-purple-600 hover:underline">{{ link.title }}</a></li>{% endfor %}</ul>{% else %}<p class="text-sm text-slate-500 italic">No notes link here.</p>{% endif %}
                    </div>
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2 text-sm">Links To (Outgoing)</h4>
                        {% if outgoing_links %}<ul class="list-disc list-inside text-sm space-y-1">{% for link in outgoing_links %}<li><a href="{{ url_for('view_note', note_id=link.id) }}" class="text-purple-600 hover:underline">{{ link.title }}</a></li>{% endfor %}</ul>{% else %}<p class="text-sm text-slate-500 italic">No outgoing links.</p>{% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            <div class="flex items-center justify-center h-full text-center text-slate-500 bg-white rounded-lg border border-dashed">
                <div>
                    <svg class="w-12 h-12 mx-auto text-slate-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                    <h3 class="mt-2 text-sm font-semibold text-slate-800">Select a Note</h3>
                    <p class="mt-1 text-sm text-slate-500">Select a note from the tree to view it, or create a new one.</p>
                </div>
            </div>
        {% endif %}
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.29.1"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.8.1"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/list@1.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@1.5.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/link@2.6.2"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@2.6.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/table@2.3.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.4"></script>

{% if current_note and current_note.content_for_editor %}
<script>
    var noteContentData = {{ current_note.content_for_editor | tojson | safe }};
</script>
{% endif %}

<script>
    function toggleAddForm(formId, event) {
        event.preventDefault();
        event.stopPropagation();
        const formDiv = document.getElementById(formId);
        if (formDiv) {
            formDiv.classList.toggle('hidden');
            if (!formDiv.classList.contains('hidden')) {
                formDiv.querySelector('input[type="text"]').focus();
            }
        }
    }

document.addEventListener('DOMContentLoaded', () => {
    const editorElement = document.getElementById('editorjs');
    const editorPane = document.querySelector('.notes-editor-pane');
    
    if (editorElement && editorPane && typeof noteContentData !== 'undefined') {
        
        console.log("Initializing Editor.js with the following data:", noteContentData);

        try {
            const editor = new EditorJS({
                holder: 'editorjs',
                autofocus: true,
                data: noteContentData,
                
                tools: {
                    header: {
                        class: Header,
                        inlineToolbar: true
                    },
                    list: {
                        class: List,
                        inlineToolbar: true
                    },
                    paragraph: {
                        class: Paragraph,
                        inlineToolbar: true,
                    },
                    quote: {
                        class: Quote,
                        inlineToolbar: true
                    },
                    inlineCode: {
                        class: InlineCode
                    },
                    link: { 
                        class: LinkTool
                    },
                    table: {
                        class: Table,
                        inlineToolbar: true
                    },
                },
            });

            const formContainer = document.getElementById('note-editor-form');
            const saveButton = document.getElementById('save-button');
            const titleInput = formContainer.querySelector('input[name="note_title"]');

            saveButton.addEventListener('click', (event) => {
                event.preventDefault();

                const noteTitle = titleInput.value;
                const updateUrl = formContainer.getAttribute('action');

                saveButton.disabled = true;
                saveButton.textContent = 'Saving...';

                editor.save().then((outputData) => {
                    const payload = {
                        title: noteTitle,
                        content: outputData
                    };

                    fetch(updateUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            createToast(data.message || 'Note saved!', 'success');
                        } else {
                            createToast('Error: ' + (data.error || 'Unknown error'), 'error');
                        }
                    })
                    .catch(err => {
                        console.error('API Error:', err);
                        createToast('A network error occurred while saving.', 'error');
                    })
                    .finally(() => {
                        saveButton.disabled = false;
                        saveButton.textContent = 'Save';
                    });

                }).catch((error) => {
                    console.error('Editor.js save failed: ', error);
                    createToast('Error preparing note data to save. See console.', 'error');
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save';
                });
            });

        } catch (error) {
            console.error("Failed to initialize Editor.js:", error);
            editorElement.innerHTML = '<div class="p-4 text-red-700 bg-red-100 rounded-md"><strong>Error: Could not load the note editor.</strong><p class="mt-2">The note data might be corrupted. This can happen if a previously saved note has an invalid format. To fix this, you may need to check the database directly.</p></div>';
            createToast('Failed to load editor for this note.', 'error');
        }
    }

    // AJAX Deletion for notes
    document.querySelectorAll('.delete-note-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const noteIdToDelete = button.dataset.noteId;
            if (confirm('Are you sure you want to delete this note?')) {
                const deleteUrlTemplate = editorPane.dataset.deleteUrlTemplate;
                const finalDeleteUrl = deleteUrlTemplate.replace('0', noteIdToDelete);

                fetch(finalDeleteUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const currentNoteId = editorPane.dataset.currentNoteId || null;
                        const notesUrl = editorPane.dataset.notesUrl;
                        document.querySelector(`li[data-note-id="${noteIdToDelete}"]`)?.remove();
                        if (currentNoteId && currentNoteId == noteIdToDelete) {
                           window.location.href = notesUrl;
                        } else {
                           createToast('Note deleted.', 'success');
                        }
                    } else {
                        createToast('Error: ' + data.error, 'error');
                    }
                }).catch(() => createToast('A server error occurred.', 'error'));
            }
        });
    });
});
</script>
{% endblock %}