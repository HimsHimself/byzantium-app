{% extends "index.html" %}

{# NEW: Recursive macro to render the folder and note tree #}
{% macro render_tree(items, item_type, current_note_id) %}
    <ul class="space-y-1 {{ 'pl-4' if item_type == 'folder' else '' }}">
        {% for item in items %}
            {% if 'children' in item %} {# It's a folder #}
                <li class="tree-item group">
                    <details {{ 'open' if current_note_id and item.id in (current_note.folder_id, current_note.id) else '' }}>
                        <summary class="flex justify-between items-center p-1 rounded-md hover:bg-slate-100 cursor-pointer">
                            <div class="flex items-center gap-2 flex-grow truncate">
                                <svg class="w-5 h-5 text-amber-500 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.5 21a3 3 0 003-3v-9a3 3 0 00-3-3h-6.879a.75.75 0 01-.53-.22L11.53 5.22a.75.75 0 00-.53-.22H4.5a3 3 0 00-3 3v12a3 3 0 003 3h15z" /></svg>
                                <span class="text-sm font-medium text-slate-700 truncate">{{ item.name }}</span>
                            </div>
                            <form action="{{ url_for('delete_folder', folder_id=item.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this folder and all its contents?');" class="shrink-0">
                                <button type="submit" class="hidden group-hover:block text-slate-400 hover:text-red-600 p-1 rounded-full">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </form>
                        </summary>
                        <div class="pt-1">
                            {{ render_tree(item.children, 'folder', current_note_id) }}
                            {{ render_tree(item.notes, 'note', current_note_id) }}
                        </div>
                    </details>
                </li>
            {% else %} {# It's a note #}
                <li class="tree-item group {% if current_note_id and current_note_id == item.id %}active{% endif %}">
                    <div class="flex justify-between items-center">
                        <a href="{{ url_for('view_note', note_id=item.id) }}" class="flex items-center gap-2 p-1 rounded-md flex-grow truncate pr-2">
                             <svg class="w-5 h-5 text-slate-400 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0016.5 9h-1.875a.375.375 0 01-.375-.375V6.75A3.75 3.75 0 0010.5 3h-4.875A1.875 1.875 0 005.625 1.5zM12.25 11.25a.75.75 0 000 1.5h4.5a.75.75 0 000-1.5h-4.5zM12 15.75a.75.75 0 01.75-.75h4.5a.75.75 0 010 1.5h-4.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>
                            <span class="text-sm font-medium truncate">{{ item.title }}</span>
                        </a>
                        <form action="{{ url_for('delete_note', note_id=item.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this note?');" class="shrink-0">
                            <button type="submit" class="hidden group-hover:block text-slate-400 hover:text-red-600 p-1 rounded-full">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </form>
                    </div>
                </li>
            {% endif %}
        {% endfor %}
    </ul>
{% endmacro %}


{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.css">
<style>
    .notes-container {
        display: flex;
        gap: 1.5rem; /* 24px */
        height: calc(100vh - 120px); /* Adjust based on header/footer height */
    }
    .notes-explorer {
        flex: 0 0 24rem; /* Fixed width for the sidebar */
        background-color: #f7f9fc;
        border-radius: 0.75rem;
        padding: 1rem;
        overflow-y: auto;
        border: 1px solid var(--byzantine-border);
    }
    .notes-editor-pane {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        min-width: 0;
    }
    .editor-container, .preview-container {
        flex: 1;
        overflow-y: auto;
        border: 1px solid var(--byzantine-border);
        border-radius: 0.75rem;
        background-color: #ffffff;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05);
    }
    
    /* Tree view styles */
    .tree-item a {
        color: var(--byzantine-slate);
        transition: all 0.2s ease-in-out;
        display: block;
    }
    .tree-item:hover a, .tree-item.active a {
        color: var(--imperial-purple);
    }
     .tree-item.active { background-color: #f4f2f7; border-radius: 0.375rem; }
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
    details > summary::before {
        content: 'â–º';
        font-size: 0.7em;
        margin-right: 0.5rem;
        transition: transform 0.2s;
    }
    details[open] > summary::before { transform: rotate(90deg); }

    /* SNQL and Note Rendering Styles */
    .prose .snql-link {
        color: var(--imperial-purple, #4B0082); background-color: #f4f2f7;
        padding: 2px 5px; border-radius: 4px; font-weight: 500;
        text-decoration: none; border-bottom: 1px solid var(--byzantine-gold, #C59B08);
        transition: background-color 0.2s ease-in-out;
    }
    .prose .snql-link:hover { background-color: #e9e4f0; text-decoration: none; }
    .prose .snql-broken-link {
        color: #992c2c; background-color: #fee2e2; padding: 1px 4px;
        border-radius: 4px; text-decoration: line-through; cursor: not-allowed;
    }
    
    /* Tribute.js Autocomplete Styles */
    .tribute-container { border: 1px solid var(--byzantine-border); border-radius: 0.5rem; background-color: #ffffff; }
    .tribute-container li { padding: 0.5rem 1rem; cursor: pointer; }
    .tribute-container li.highlight, .tribute-container li:hover { background-color: #f4f2f7; color: var(--imperial-purple, #4B0082); }
    .no-match { padding: 0.5rem 1rem; color: #64748b; }
</style>

<div class="notes-container">

    <div class="notes-explorer">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">Scribe's Desk</h2>
        <div class="space-y-4">
            <div>
                <h3 class="text-xs font-semibold uppercase text-slate-500 mb-2">Folders</h3>
                {{ render_tree(notes_tree, 'folder', current_note.id if current_note else None) }}
            </div>

            {% if orphaned_notes %}
            <div class="pt-4 border-t border-slate-200">
                <h3 class="text-xs font-semibold uppercase text-slate-500 mb-2">Orphaned Notes</h3>
                {{ render_tree(orphaned_notes, 'note', current_note.id if current_note else None) }}
            </div>
            {% endif %}
        </div>
        <div class="mt-6 pt-6 border-t border-slate-200">
             <form method="POST" action="{{ url_for('add_note') }}" class="space-y-2">
                <input type="text" name="note_title" placeholder="New Note Title..." required class="form-input w-full p-2 text-sm rounded-md">
                <button type="submit" class="btn-primary text-sm w-full py-2 rounded-md">Create Note</button>
            </form>
        </div>
    </div>

    <div class="notes-editor-pane">
        {% if current_note %}
            <form method="POST" action="{{ url_for('update_note', note_id=current_note.id) }}" class="flex flex-col h-full space-y-4">
                <div class="flex items-center gap-4">
                    <input type="text" name="note_title" value="{{ current_note.title }}" class="form-input text-xl font-bold flex-grow p-2 rounded-md">
                    <button type="submit" class="btn-primary font-semibold py-2 px-6 rounded-md shrink-0">Save</button>
                     <button form="delete_form" type="submit" class="text-red-500 hover:text-red-700 text-sm font-semibold">Delete</button>
                </div>
                
                <div class="grid grid-cols-2 gap-4 flex-grow min-h-0">
                    <div class="editor-container flex flex-col">
                        <div class="p-2 bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
                            Markdown (use [[Note]] for links, /h1, /h2 for headers)
                        </div>
                        <textarea id="note_content" name="note_content" class="w-full h-full p-4 form-input rounded-b-md text-sm resize-none border-0 focus:ring-0" style="font-family: 'Fira Code', 'Consolas', monospace;">{{ content_for_editing if content_for_editing is not none else '' }}</textarea>
                    </div>

                    <div class="preview-container flex flex-col">
                        <div class="p-2 bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
                           Rendered Preview
                        </div>
                        <div id="rendered_content" class="prose prose-sm max-w-none p-4 overflow-auto">
                            {{ content_as_html | safe if content_as_html else '<p class="text-slate-400 italic">This note is empty.</p>'}}
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 pt-4">
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2">Linked From (Backlinks)</h4>
                        {% if backlinks %}
                            <ul class="list-disc list-inside text-sm space-y-1">
                                {% for link in backlinks %}
                                    <li><a href="{{ url_for('view_note', note_id=link.id) }}" class="text-purple-600 hover:underline">{{ link.title }}</a></li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-sm text-slate-500 italic">No notes link here.</p>
                        {% endif %}
                    </div>
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2">Links To (Outgoing)</h4>
                            {% if outgoing_links %}
                            <ul class="list-disc list-inside text-sm space-y-1">
                                {% for link in outgoing_links %}
                                    <li><a href="{{ url_for('view_note', note_id=link.id) }}" class="text-purple-600 hover:underline">{{ link.title }}</a></li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-sm text-slate-500 italic">No outgoing links.</p>
                        {% endif %}
                    </div>
                </div>
            </form>
            <form id="delete_form" action="{{ url_for('delete_note', note_id=current_note.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this note permanently?');" class="hidden"></form>

        {% else %}
            <div class="flex items-center justify-center h-full text-center text-slate-500 bg-white rounded-lg border border-dashed">
                <div>
                    <svg class="w-12 h-12 mx-auto text-slate-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                    <h3 class="mt-2 text-sm font-semibold text-gray-900">Select a Note</h3>
                    <p class="mt-1 text-sm text-gray-500">Select a note from the tree to view it, or create a new one.</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const noteContentElement = document.getElementById('note_content');
    const renderedContentElement = document.getElementById('rendered_content');
    
    if (noteContentElement) {
        // --- Tribute.js for [[Note]] linking ---
        const tribute = new Tribute({
            trigger: '[[',
            values: function(text, cb) {
                // Only search if there are at least 1 character
                if (text.length > 0) {
                    fetch(`/api/notes/search?q=${encodeURIComponent(text)}`)
                        .then(response => response.json())
                        .then(data => cb(data.map(title => ({ key: title, value: title }))))
                        .catch(() => cb([]));
                } else {
                    cb([]);
                }
            },
            selectTemplate: item => `[[${item.original.value}]]`,
            menuItemTemplate: item => item.string,
            noMatchTemplate: () => '<li class="no-match">No matches found</li>',
            allowSpaces: true,
            closeOnScroll: true,
            endCharacter: ']]',
        });
        tribute.attach(noteContentElement);

        // --- Live Preview & Slash Commands ---
        let debounceTimer;
        noteContentElement.addEventListener('input', () => {
            // Handle Slash commands
            const text = noteContentElement.value;
            const cursorPos = noteContentElement.selectionStart;
            const textBeforeCursor = text.substring(0, cursorPos);
            
            const match = textBeforeCursor.match(/\/h([1-6])\s$/);
            if (match) {
                const level = parseInt(match[1], 10);
                const header = '#'.repeat(level) + ' ';
                const newText = textBeforeCursor.replace(/\/h[1-6]\s$/, header) + text.substring(cursorPos);
                
                noteContentElement.value = newText;
                noteContentElement.selectionStart = noteContentElement.selectionEnd = cursorPos - match[0].length + header.length;
            }

            // Debounce the preview rendering to avoid too many API calls
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                fetch('/api/render_markdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: noteContentElement.value })
                })
                .then(response => response.json())
                .then(data => {
                    if(data.html) {
                        renderedContentElement.innerHTML = data.html;
                    } else {
                        renderedContentElement.innerHTML = '<p class="text-slate-400 italic">Start typing to see a preview...</p>';
                    }
                });
            }, 300); // 300ms delay
        });
    }
});
</script>
{% endblock %}