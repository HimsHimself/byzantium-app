<!DOCTYPE html>
<html lang="en"> <!-- Theme is applied by the script below -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byzantium Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%234B0082%22>â€ </text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- NEW: Anti-flash script. Applies theme before rendering. -->
    <script>
        (function() {
            try {
                var theme = localStorage.getItem('byzantium-theme') || 'byzantium';
                document.documentElement.setAttribute('data-theme', theme);
            } catch (e) {
                console.error("Could not set theme from localStorage", e);
            }
        })();
    </script>
    
    <style>
        body {
            /* Prevents flash of unstyled content */
            visibility: hidden;
        }

        :root {
            --color-background: #FDFDF6;
            --color-text-primary: #2d3748;
            --color-text-secondary: #4a5568;
            --color-text-muted: #94a3b8;
            --color-text-inverted: #ffffff;
            --color-surface: #ffffff;
            --color-border: #e2e8f0;
            --color-primary: #4B0082;
            --color-primary-hover: #3A006A;
            --color-primary-light: #f4f2f7;
            --color-secondary: #C59B08;
            --color-accent: #6d28d9;
            --font-heading: 'Inter', sans-serif;
            --font-body: 'Inter', sans-serif;
        }
        
        /* UPDATED: Refined Mass Effect theme colors for readability */
        [data-theme="mass-effect"] {
            --color-background: #0D1117; /* Darker, like Github dark */
            --color-text-primary: #e6edf3; /* Off-white for text */
            --color-text-secondary: #8b949e; /* Dimmer grey */
            --color-text-muted: #586069;
            --color-text-inverted: #e6edf3;
            --color-surface: #161B22; /* Slightly lighter surface for cards */
            --color-border: #30363d;
            --color-primary: #f78166; /* Softer, less fluorescent orange */
            --color-primary-hover: #f46a4d;
            --color-primary-light: #222933; /* Darker highlight for hover */
            --color-secondary: #58a6ff; /* A calmer blue accent */
            --color-accent: #f78166;
        }

        /* Base styles using the variables */
        body {
            font-family: var(--font-body);
            background-color: var(--color-background);
            color: var(--color-text-primary);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e2e8f0' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sidebar {
            background-color: var(--color-surface);
            border-right: 1px solid var(--color-border);
        }

        .sidebar-link {
            color: var(--color-text-secondary);
            transition: all 0.2s ease-in-out;
            border-left: 4px solid transparent;
        }

        .sidebar-link:hover {
            color: var(--color-primary);
            background-color: var(--color-primary-light);
        }

        .sidebar-link.active {
            color: var(--color-primary);
            background-color: var(--color-primary-light);
            border-left-color: var(--color-secondary);
            font-weight: 600;
        }
        
        .header {
            background-color: color-mix(in srgb, var(--color-surface) 85%, transparent);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--color-border);
        }

        .brand-text { color: var(--color-primary); }
        .brand-accent { color: var(--color-secondary); }

        .content-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-top: 3px solid var(--color-primary);
            box-shadow: 0 5px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            border-radius: 0.75rem;
        }

        .content-card h3 {
            color: var(--color-text-primary); /* Ensure headers use theme text color */
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.75rem;
            margin-bottom: 1.25rem;
        }
        
        .form-input, .form-checkbox, .form-select, .form-textarea {
            background-color: color-mix(in srgb, var(--color-background) 50%, var(--color-surface) 50%);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            transition: all 0.2s ease-in-out;
        }

        .form-input:focus, .form-checkbox:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--color-primary) 20%, transparent);
            outline: none;
        }
        .form-checkbox:checked {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }

        .btn-primary {
            background-image: linear-gradient(to top right, var(--color-primary), var(--color-accent));
            color: var(--color-text-inverted);
            font-weight: 500;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px -1px rgba(0,0,0,.1);
            transition: all 0.3s ease;
        }
        
        [data-theme='byzantium'] .btn-primary {
             color: #ffffff;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 12px 0 color-mix(in srgb, var(--color-primary) 30%, transparent);
            transform: translateY(-2px);
        }
        
        .task-item label { transition: color 0.2s; }
        .task-item input:checked + label {
            text-decoration: line-through;
            color: var(--color-text-muted);
        }

        [data-theme="mass-effect"] .form-input::placeholder {
            color: var(--color-text-muted);
        }
        
        [data-theme="mass-effect"] .task-item input:checked + label {
             color: var(--color-text-muted);
        }

        [data-theme="mass-effect"] a {
             color: var(--color-secondary);
        }
        
        [data-theme="mass-effect"] .sidebar-link, [data-theme="mass-effect"] #pageTitle {
            color: var(--color-text-secondary);
        }
        [data-theme="mass-effect"] .sidebar-link:hover {
            color: var(--color-primary);
        }
        [data-theme="mass-effect"] .sidebar-link.active {
             color: var(--color-primary);
             border-left-color: var(--color-secondary);
        }
    </style>
</head>
<body class="flex h-screen antialiased">

    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3 w-80"></div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages" data-messages='{{ messages|tojson|safe }}' class="hidden"></div>
        {% endif %}
    {% endwith %}

    <aside class="sidebar w-64 space-y-2 py-4 px-2 fixed inset-y-0 left-0 transform md:translate-x-0 -translate-x-full transition-transform duration-200 ease-in-out z-30 shadow-lg">
        <div class="px-4 py-2 mb-4">
            <a href="{{ url_for('hello') }}" class="text-2xl font-bold brand-text">
                Byzantium <span class="brand-accent text-3xl align-middle">&dagger;</span>
            </a>
        </div>
        <nav>
            <a href="{{ url_for('hello') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if request.endpoint == 'hello' %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span>Dashboard</span>
            </a>
            <a href="{{ url_for('notes_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'notes_page' in request.endpoint or 'note' in request.endpoint %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <span>Notes</span>
            </a>
            <a href="{{ url_for('logs_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'log' in request.endpoint and 'food' not in request.endpoint %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                <span>Logs</span>
            </a>
            <a href="{{ url_for('oracle_chat_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if request.endpoint == 'oracle_chat_page' %}active{% endif %}">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                <span>Oracle Chat</span> </a>
            <a href="{{ url_for('add_food_log') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'food_log' in request.endpoint %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                <span>Food Log</span>
            </a>
            <a href="{{ url_for('collection_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'collection' in request.endpoint %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.375M9 12h6.375M9 17.25h6.375M12 3c-1.12 0-2.096.342-2.844.975-1.017.907-1.656 2.22-1.656 3.652v1.5c0 1.432.639 2.745 1.656 3.652C9.904 13.158 10.88 13.5 12 13.5s2.096-.342 2.844-.975c1.017-.907 1.656-2.22 1.656-3.652v-1.5c0-1.432-.639-2.745-1.656-3.652C14.096 3.342 13.12 3 12 3z"></path></svg>
                <span>Collection</span>
            </a>
            <a href="{{ url_for('view_activity_log') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if request.endpoint == 'view_activity_log' %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span>Activity Log</span>
            </a>
        </nav>
        <div class="absolute bottom-4 left-0 w-full px-4 space-y-4">
             <div class="relative">
                <label for="theme-switcher" class="block text-xs font-medium text-slate-500 mb-1">Theme</label>
                <select id="theme-switcher" class="form-select w-full p-2 text-sm rounded-md appearance-none">
                    <option value="byzantium">Byzantium</option>
                    <option value="mass-effect">Mass Effect</option>
                </select>
                 <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" style="top: 1.25rem;">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
             <a href="{{ url_for('logout') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md w-full text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <div class="flex-1 flex flex-col md:ml-64">
        <header class="header p-4 shadow-sm sticky top-0 z-10">
            <div class="flex justify-between items-center">
                <button id="sidebarToggle" class="md:hidden text-slate-600 hover:text-purple-700 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 id="pageTitle" class="text-xl font-semibold tracking-wider">Dashboard</h1>
                <div class="w-6"></div> 
            </div>
        </header>

        <main class="flex-1 p-6 md:p-8 overflow-y-auto">
            {% block content %}
            <!-- Content block will be inherited -->
            {% endblock %}
        </main>
    </div>

    <script>
        const themeSwitcher = document.getElementById('theme-switcher');
        const htmlElement = document.documentElement;

        function setTheme(theme) {
            htmlElement.setAttribute('data-theme', theme);
            localStorage.setItem('byzantium-theme', theme);
            if (themeSwitcher.value !== theme) {
                themeSwitcher.value = theme;
            }
        }

        themeSwitcher.addEventListener('change', (event) => {
            setTheme(event.target.value);
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Theme is now set by the inline script in <head>
            // This just ensures the dropdown matches the already-set theme.
            const savedTheme = localStorage.getItem('byzantium-theme') || 'byzantium';
            if (themeSwitcher.value !== savedTheme) {
                 themeSwitcher.value = savedTheme;
            }
            
            // Make body visible now that styles and theme are applied
            document.body.style.visibility = 'visible';
            
            const flashContainer = document.getElementById('flash-messages');
            if (flashContainer) {
                const messages = JSON.parse(flashContainer.getAttribute('data-messages') || '[]');
                if (messages && messages.length > 0) {
                    messages.forEach(msg => {
                        const [category, message] = msg;
                        createToast(message, category);
                    });
                }
            }

            const sidebar = document.querySelector('aside.sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarToggle) {
                const openSidebar = () => {
                    sidebar.classList.remove('-translate-x-full');
                    sidebarOverlay.classList.remove('hidden');
                };
                const closeSidebar = () => {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                };
                sidebarToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (sidebar.classList.contains('-translate-x-full')) openSidebar();
                    else closeSidebar();
                });
                sidebarOverlay.addEventListener('click', closeSidebar);
            }

            const pageTitleElement = document.getElementById('pageTitle');
            const activeLink = document.querySelector('.sidebar-link.active span');
            if (pageTitleElement && activeLink) {
                 pageTitleElement.textContent = activeLink.textContent;
            }

            // Task management and other scripts would go here...
        });

        function createToast(message, category) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            const toast = document.createElement('div');
            toast.className = 'flex items-center p-4 text-white rounded-lg shadow-lg transition-all duration-300 transform translate-x-full opacity-0';
            let bgColor = 'bg-gray-700';
            if (category === 'success') bgColor = 'bg-green-600';
            if (category === 'error') bgColor = 'bg-red-600';
            if (category === 'info') bgColor = 'bg-blue-600';
            toast.classList.add(bgColor);
            toast.innerHTML = `<span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 100);
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-2');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }
    </script>
</body>
</html>