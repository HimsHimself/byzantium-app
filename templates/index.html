<!DOCTYPE html>
{% from '_macros.html' import home_icon, pencil_square_icon, newspaper_icon, sparkles_icon, archive_box_icon, building_library_icon, folder_icon, document_chart_bar_icon, arrow_left_on_rectangle_icon, chevron_down_icon, bars_3_icon, check_circle_icon, edit_icon, archive_box_icon as archive_box_heading_icon %}
<html lang="en"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byzantium Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%234B0082%22>†</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Inter:wght@300;400;500;600;700;800&family=Old+Standard+TT:wght@700&display=swap" rel="stylesheet">
    
    <script>
        (function() {
            try {
                var theme = localStorage.getItem('byzantium-theme') || 'byzantium';
                document.documentElement.setAttribute('data-theme', theme);
            } catch (e) {
                console.error("Could not set theme from localStorage", e);
            }
        })();
    </script>
    
    <style>
        body {
            /* Prevents flash of unstyled content */
            visibility: hidden;
        }

        :root {
            --color-background: #FDFDF6;
            --color-text-primary: #2d3748;
            --color-text-secondary: #4a5568;
            --color-text-muted: #94a3b8;
            --color-text-inverted: #ffffff;
            --color-surface: #ffffff;
            --color-border: #e2e8f0;
            --color-primary: #4B0082;
            --color-primary-hover: #3A006A;
            --color-primary-light: #f4f2f7;
            --color-secondary: #C59B08;
            --color-accent: #6d28d9;
            --font-brand: 'Inter', sans-serif;
            --font-body: 'Inter', sans-serif;
        }
        
        [data-theme="mass-effect"] {
            --color-background: #0D1117;
            --color-text-primary: #e6edf3;
            --color-text-secondary: #8b949e;
            --color-text-muted: #586069;
            --color-text-inverted: #0D1117; /* Dark text for buttons */
            --color-surface: #161B22;
            --color-border: #30363d;
            --color-primary: #f78166;
            --color-primary-hover: #f46a4d;
            --color-primary-light: #222933;
            --color-secondary: #58a6ff;
            --color-accent: #f78166;
            --font-brand: 'Inter', sans-serif;
        }

        [data-theme="dune"] {
            --color-background: #F5EFE6; /* Parchment background */
            --color-text-primary: #4A403A; /* Dark brown text */
            --color-text-secondary: #7E6C5F;
            --color-text-muted: #A89B8F;
            --color-text-inverted: #FFFFFF; /* White text on buttons */
            --color-surface: #E8E0D5; /* Darker parchment for cards */
            --color-border: #D3C5B5;
            --color-primary: #D97706; /* Spice Orange */
            --color-primary-hover: #B45309;
            --color-primary-light: #F3EADD;
            --color-secondary: #3A5F7A; /* Fremen Blue */
            --color-accent: #E58D2E;
            --font-brand: 'Cinzel Decorative', serif; /* Stylized font for branding */
        }
        
        /* NEW: WW1 Theme */
        [data-theme="ww1"] {
            --color-background: #EAE6D9; /* Aged paper */
            --color-text-primary: #3D2B1F; /* Dark brown, almost black */
            --color-text-secondary: #5C5248;
            --color-text-muted: #8E8278;
            --color-text-inverted: #F5F5F5;
            --color-surface: #DCD6C8; /* Muted card background */
            --color-border: #C8BFB2;
            --color-primary: #8B0000; /* Dark Red (Poppy) */
            --color-primary-hover: #6E0000;
            --color-primary-light: #E0D9CC;
            --color-secondary: #556B2F; /* Olive Drab Green */
            --color-accent: #A52A2A; /* Lighter Brown/Red */
            --font-brand: '"Old Standard TT"', serif;
        }

        /* Base styles using the variables */
        body {
            font-family: var(--font-body);
            background-color: var(--color-background);
            color: var(--color-text-primary);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e2e8f0' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        [data-theme="dune"] body {
             background-image: url("data:image/svg+xml,%3Csvg width='84' height='48' viewBox='0 0 84 48' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h12v12h12v12h12v12h12v12h12v12h12v12h-12v-12h-12v-12h-12v-12h-12v-12h-12v-12z' fill='%23D3C5B5' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        [data-theme="ww1"] body {
             background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='p' width='100' height='100' patternUnits='userSpaceOnUse'%3E%3Cpath d='M50 0 v100 M0 50 h100' stroke='%23C8BFB2' stroke-width='1' shape-rendering='crispEdges'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23p)' opacity='0.2'/%3E%3C/svg%3E");
        }

        .brand-title { font-family: var(--font-brand); }
        .sidebar { background-color: var(--color-surface); border-right: 1px solid var(--color-border); }
        .sidebar-link { color: var(--color-text-secondary); transition: all 0.2s ease-in-out; border-left: 4px solid transparent; }
        .sidebar-link:hover { color: var(--color-primary); background-color: var(--color-primary-light); }
        .sidebar-link.active { color: var(--color-primary); background-color: var(--color-primary-light); border-left-color: var(--color-secondary); font-weight: 600; }
        .header { background-color: color-mix(in srgb, var(--color-surface) 85%, transparent); backdrop-filter: blur(8px); border-bottom: 1px solid var(--color-border); }
        .brand-text { color: var(--color-primary); }
        .brand-accent { color: var(--color-secondary); }
        .content-card { background-color: var(--color-surface); border: 1px solid var(--color-border); border-top: 3px solid var(--color-primary); box-shadow: 0 5px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1); border-radius: 0.75rem; }
        .content-card h3 { color: var(--color-text-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.75rem; margin-bottom: 1.25rem; }
        .form-input, .form-checkbox, .form-select, .form-textarea { background-color: var(--color-background); border: 1px solid var(--color-border); color: var(--color-text-primary); transition: all 0.2s ease-in-out; }
        .form-input:focus, .form-checkbox:focus, .form-select:focus, .form-textarea:focus { border-color: var(--color-primary); box-shadow: 0 0 0 2px color-mix(in srgb, var(--color-primary) 20%, transparent); outline: none; }
        .form-checkbox:checked { background-color: var(--color-primary); border-color: var(--color-primary); }
        .btn-primary { background-image: linear-gradient(to top right, var(--color-primary), var(--color-accent)); color: var(--color-text-inverted); font-weight: 500; box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px -1px rgba(0,0,0,.1); transition: all 0.3s ease; }
        .btn-primary:hover { box-shadow: 0 4px 12px 0 color-mix(in srgb, var(--color-primary) 30%, transparent); transform: translateY(-2px); }
        .btn-reset { background-color: #e2e8f0; color: #334155; font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; text-align: center; transition: background-color 0.2s; }
        .btn-reset:hover { background-color: #cbd5e1; }
        .task-item label { transition: color 0.2s; }
        .task-item input:checked + label { text-decoration: line-through; color: var(--color-text-muted); }
        [data-theme='byzantium'] .btn-primary { color: #ffffff; }

        /* Dashboard Hero Style */
        .dashboard-hero {
            border: 2px solid var(--color-primary);
            background-color: color-mix(in srgb, var(--color-primary) 10%, var(--color-surface));
            color: var(--color-primary);
        }
        .dashboard-hero h2 {
           color: var(--color-primary);
           font-family: var(--font-brand);
        }
        .dashboard-hero p {
            color: color-mix(in srgb, var(--color-primary) 70%, var(--color-surface));
        }

        [data-theme="mass-effect"] .dashboard-hero h2, [data-theme="mass-effect"] .dashboard-hero p,
        [data-theme="dune"] .dashboard-hero,
        [data-theme="ww1"] .dashboard-hero {
            color: var(--color-text-primary);
        }
        [data-theme="dune"] .dashboard-hero h2,
        [data-theme="ww1"] .dashboard-hero h2 {
             color: var(--color-text-primary);
        }
        [data-theme="dune"] .dashboard-hero p,
        [data-theme="ww1"] .dashboard-hero p {
            color: var(--color-text-secondary);
        }

        /* NEW: Theme-aware Stat Card */
        .stat-card {
            background-color: var(--color-primary-light);
            border: 1px solid color-mix(in srgb, var(--color-primary) 25%, var(--color-border));
        }
        .stat-card .stat-title {
            color: var(--color-text-secondary);
        }
        .stat-card .stat-value {
            color: var(--color-primary);
        }
        .stat-card .stat-unit {
            color: var(--color-text-secondary);
        }
        [data-theme="mass-effect"] .stat-card {
            border-color: var(--color-border);
        }
        [data-theme="mass-effect"] .stat-card .stat-title {
            color: var(--color-text-primary); /* Brighter title for dark BG */
        }

        /* Themed radio buttons for food log */
        .themed-radio-label {
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
            background-color: var(--color-surface);
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .themed-radio-label:hover {
            background-color: var(--color-primary-light);
            border-color: color-mix(in srgb, var(--color-border) 50%, var(--color-primary) 50%);
        }
        input[type="radio"]:checked + .themed-radio-label {
            background-color: var(--color-primary-light);
            color: var(--color-primary);
            border-color: var(--color-primary);
            font-weight: 600;
        }

        /* Comprehensive Theme Overrides */
        [data-theme="mass-effect"] a, [data-theme="dune"] a, [data-theme="ww1"] a { color: var(--color-secondary); }
        [data-theme="mass-effect"] .sidebar-link, [data-theme="mass-effect"] #pageTitle, [data-theme="mass-effect"] .content-card h2, [data-theme="mass-effect"] .text-slate-800,
        [data-theme="dune"] .sidebar-link, [data-theme="dune"] #pageTitle, [data-theme="dune"] .content-card h2, [data-theme="dune"] .text-slate-800,
        [data-theme="ww1"] .sidebar-link, [data-theme="ww1"] #pageTitle, [data-theme="ww1"] .content-card h2, [data-theme="ww1"] .text-slate-800 { color: var(--color-text-primary); }
        [data-theme="mass-effect"] .sidebar-link:hover, [data-theme="dune"] .sidebar-link:hover, [data-theme="ww1"] .sidebar-link:hover { color: var(--color-primary); }
        [data-theme="mass-effect"] .sidebar-link.active, [data-theme="dune"] .sidebar-link.active, [data-theme="ww1"] .sidebar-link.active { color: var(--color-primary); border-left-color: var(--color-secondary); }
        [data-theme="mass-effect"] .form-input::placeholder, [data-theme="dune"] .form-input::placeholder, [data-theme="ww1"] .form-input::placeholder { color: var(--color-text-muted); }
        [data-theme="mass-effect"] .task-item input:checked + label, [data-theme="mass-effect"] .text-slate-500,
        [data-theme="dune"] .task-item input:checked + label, [data-theme="dune"] .text-slate-500,
        [data-theme="ww1"] .task-item input:checked + label, [data-theme="ww1"] .text-slate-500 { color: var(--color-text-secondary); }
        [data-theme="mass-effect"] .bg-white, [data-theme="mass-effect"] .notes-editor-pane > div,
        [data-theme="dune"] .bg-white, [data-theme="dune"] .notes-editor-pane > div,
        [data-theme="ww1"] .bg-white, [data-theme="ww1"] .notes-editor-pane > div { background-color: var(--color-surface) !important; }
        [data-theme="mass-effect"] .notes-explorer, [data-theme="dune"] .notes-explorer, [data-theme="ww1"] .notes-explorer { background-color: var(--color-surface); border: 1px solid var(--color-border); }
        [data-theme="mass-effect"] .tree-item a, [data-theme="dune"] .tree-item a, [data-theme="ww1"] .tree-item a { color: var(--color-text-secondary); }
        [data-theme="mass-effect"] .tree-item.active, [data-theme="dune"] .tree-item.active, [data-theme="ww1"] .tree-item.active { background-color: var(--color-primary-light); }
        [data-theme="mass-effect"] .tree-item.active a, [data-theme="dune"] .tree-item.active a, [data-theme="ww1"] .tree-item.active a { color: var(--color-primary); font-weight: 600; }
        [data-theme="mass-effect"] .border-dashed, [data-theme="dune"] .border-dashed, [data-theme="ww1"] .border-dashed { border-color: var(--color-border); }
        [data-theme="mass-effect"] .text-gray-900, [data-theme="mass-effect"] .text-slate-700,
        [data-theme="dune"] .text-gray-900, [data-theme="dune"] .text-slate-700,
        [data-theme="ww1"] .text-gray-900, [data-theme="ww1"] .text-slate-700 { color: var(--color-text-primary); }
        [data-theme="mass-effect"] .text-gray-500, [data-theme="dune"] .text-gray-500, [data-theme="ww1"] .text-gray-500 { color: var(--color-text-secondary); }
        [data-theme="mass-effect"] .bg-slate-50, [data-theme="mass-effect"] .bg-slate-50\/50,
        [data-theme="dune"] .bg-slate-50, [data-theme="dune"] .bg-slate-50\/50,
        [data-theme="ww1"] .bg-slate-50, [data-theme="ww1"] .bg-slate-50\/50 { background-color: color-mix(in srgb, var(--color-surface), var(--color-background) 50%) !important; }
        [data-theme="mass-effect"] .bg-slate-100, [data-theme="dune"] .bg-slate-100, [data-theme="ww1"] .bg-slate-100 { background-color: var(--color-primary-light) !important; }
        [data-theme="mass-effect"] .hover\:bg-slate-50:hover, [data-theme="mass-effect"] .hover\:bg-slate-200:hover,
        [data-theme="dune"] .hover\:bg-slate-50:hover, [data-theme="dune"] .hover\:bg-slate-200:hover,
        [data-theme="ww1"] .hover\:bg-slate-50:hover, [data-theme="ww1"] .hover\:bg-slate-200:hover { background-color: var(--color-primary-light) !important; }
        [data-theme="mass-effect"] .bg-blue-100, [data-theme="dune"] .bg-blue-100, [data-theme="ww1"] .bg-blue-100 { background-color: color-mix(in srgb, var(--color-secondary) 15%, transparent); }
        [data-theme="mass-effect"] .text-blue-800, [data-theme="dune"] .text-blue-800, [data-theme="ww1"] .text-blue-800 { color: var(--color-text-primary); }
        [data-theme="mass-effect"] .bg-purple-100, [data-theme="dune"] .bg-purple-100, [data-theme="ww1"] .bg-purple-100 { background-color: color-mix(in srgb, var(--color-primary) 15%, transparent); }
        [data-theme="mass-effect"] .text-purple-800, [data-theme="dune"] .text-purple-800, [data-theme="ww1"] .text-purple-800 { color: var(--color-text-primary); }
        [data-theme="mass-effect"] .text-purple-700, [data-theme="dune"] .text-purple-700, [data-theme="ww1"] .text-purple-700 { color: var(--color-secondary); }
        [data-theme="mass-effect"] .prose, [data-theme="dune"] .prose, [data-theme="ww1"] .prose { color: var(--color-text-primary); }
        [data-theme="mass-effect"] .btn-primary, [data-theme="dune"] .btn-primary, [data-theme="ww1"] .btn-primary { color: var(--color-text-inverted); font-weight: 600; }
        [data-theme="mass-effect"] .btn-reset { background-color: var(--color-surface); color: var(--color-text-primary); border: 1px solid var(--color-border); }
        [data-theme="mass-effect"] .btn-reset:hover { background-color: var(--color-border); }
        [data-theme="dune"] .btn-reset, [data-theme="ww1"] .btn-reset { background-color: var(--color-surface); color: var(--color-text-primary); border: 1px solid var(--color-border); }
        [data-theme="dune"] .btn-reset:hover, [data-theme="ww1"] .btn-reset:hover { background-color: var(--color-background); }


    </style>
</head>
<body class="flex h-screen antialiased">

    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3 w-80"></div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages" data-messages='{{ messages|tojson|safe }}' class="hidden"></div>
        {% endif %}
    {% endwith %}

    <aside class="sidebar w-64 space-y-2 py-4 px-2 fixed inset-y-0 left-0 transform md:translate-x-0 -translate-x-full transition-transform duration-200 ease-in-out z-30 shadow-lg">
        <div class="px-4 py-2 mb-4">
            <a href="{{ url_for('hello') }}" class="text-2xl font-bold brand-text brand-title">
                Byzantium <span class="brand-accent text-3xl align-middle">&dagger;</span>
            </a>
        </div>
        <nav>
            <a href="{{ url_for('hello') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if request.endpoint == 'hello' %}active{% endif %}">
                {{ home_icon() }}
                <span>Dashboard</span>
            </a>
            <a href="{{ url_for('notes_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'notes_page' in request.endpoint or 'note' in request.endpoint %}active{% endif %}">
                {{ pencil_square_icon() }}
                <span>Notes</span>
            </a>
            <a href="{{ url_for('logs_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'log' in request.endpoint and 'food' not in request.endpoint %}active{% endif %}">
                {{ newspaper_icon() }}
                <span>Logs</span>
            </a>
            <a href="{{ url_for('oracle_chat_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if request.endpoint == 'oracle_chat_page' %}active{% endif %}">
                 {{ sparkles_icon() }}
                <span>Oracle Chat</span> </a>
            <a href="{{ url_for('add_food_log') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'food_log' in request.endpoint %}active{% endif %}">
                {{ archive_box_icon() }}
                <span>Food Log</span>
            </a>
            <a href="{{ url_for('collection_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'collection' in request.endpoint %}active{% endif %}">
                {{ building_library_icon() }}
                <span>Collection</span>
            </a>
            <a href="{{ url_for('files_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'files_page' in request.endpoint %}active{% endif %}">
                {{ folder_icon() }}
                <span>Files</span>
            </a>
            <a href="{{ url_for('view_activity_log') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if request.endpoint == 'view_activity_log' %}active{% endif %}">
                {{ document_chart_bar_icon() }}
                <span>Activity Log</span>
            </a>
        </nav>
        <div class="absolute bottom-4 left-0 w-full px-4 space-y-4">
             <div class="relative">
                <label for="theme-switcher" class="block text-xs font-medium text-slate-500 mb-1">Theme</label>
                <select id="theme-switcher" class="form-select w-full p-2 text-sm rounded-md appearance-none">
                    <option value="byzantium">Byzantium</option>
                    <option value="mass-effect">Mass Effect</option>
                    <option value="dune">Dune</option>
                    <option value="ww1">WW1</option>
                </select>
                 <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" style="top: 1.25rem;">
                    {{ chevron_down_icon(classes='text-gray-500') }}
                </div>
            </div>
             <a href="{{ url_for('logout') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md w-full text-sm">
                {{ arrow_left_on_rectangle_icon() }}
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <div class="flex-1 flex flex-col md:ml-64 overflow-x-hidden">
        <header class="header p-4 shadow-sm sticky top-0 z-10">
            <div class="flex justify-between items-center">
                <button id="sidebarToggle" class="md:hidden text-slate-600 hover:text-purple-700 focus:outline-none">
                    {{ bars_3_icon() }}
                </button>
                <h1 id="pageTitle" class="text-xl font-semibold tracking-wider">Dashboard</h1>
                <div class="w-6"></div> 
            </div>
        </header>

        <main class="flex-1 p-6 md:p-8 overflow-y-auto">
            {% block content %}
            <div class="space-y-8">
                <div class="dashboard-hero rounded-lg p-4 md:p-6">
                    <h2 class="text-2xl lg:text-3xl font-bold">Your Imperial Dashboard</h2>
                    <p class="mt-1 text-sm lg:text-base hidden md:block">A summary of your personal archives and daily logs.</p>
                </div>
            
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
                    <div class="content-card p-6 flex flex-col lg:col-span-2 min-h-[450px]">
                        <h3 class="flex items-center text-lg font-semibold tracking-wide">
                            {{ check_circle_icon(classes='w-6 h-6 mr-3 brand-accent') }}
                            Tasks
                        </h3>
                        <div id="task-list" class="space-y-1 flex-grow">
                            {% if tasks %}
                                {% for task in tasks %}
                                <div class="task-item flex items-center justify-between py-2" data-task-id="{{ task.id }}">
                                    <div class="flex items-center">
                                        <input id="task-{{ task.id }}" type="checkbox" class="form-checkbox h-5 w-5 rounded text-purple-600 focus:ring-purple-500" {% if task.is_completed %}checked{% endif %}>
                                        <label for="task-{{ task.id }}" class="ml-3 text-sm font-medium">{{ task.title }}</label>
                                    </div>
                                    {% if task.due_date %}
                                        <span class="text-xs bg-slate-100 px-2 py-1 rounded-full whitespace-nowrap">{{ task.due_date.strftime('%d %b, %H:%M') }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% else %}
                                <p id="no-tasks-msg" class="italic text-sm">No outstanding tasks. Well done!</p>
                            {% endif %}
                        </div>
                        <form id="add-task-form" class="mt-auto flex flex-col gap-2 pt-4 border-t">
                            <div class="flex gap-2">
                                <input type="text" id="new-task-title" placeholder="Add a new task..." class="form-input flex-grow p-2 text-sm rounded-md">
                                <button type="submit" class="btn-primary text-sm font-semibold px-4 py-2 rounded-md shrink-0">Add</button>
                            </div>
                            <input type="datetime-local" id="new-task-due-date" title="Set an optional due date" class="form-input p-2 text-sm rounded-md w-full">
                        </form>
                    </div>

                    <div class="lg:col-span-1 space-y-8">
                        <div class="content-card p-6 flex flex-col">
                            <h3 class="flex items-center text-lg font-semibold tracking-wide">
                                {{ edit_icon(classes='w-6 h-6 mr-3 brand-accent') }}
                                Scribe's Desk
                            </h3>
                            {% if recent_notes %}
                                <ul class="space-y-2">
                                    {% for note in recent_notes %}
                                        <li class="flex justify-between items-baseline">
                                            <a href="{{ url_for('view_note', note_id=note.id) }}" class="hover:text-purple-700 truncate" title="{{ note.title }}">{{ note.title }}</a>
                                            <span class="text-xs text-slate-400 flex-shrink-0 ml-2">{{ note.updated_at.strftime('%d %b') }}</span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="italic text-sm">No notes found.</p>
                            {% endif %}
                            <div class="mt-auto pt-4">
                                <a href="{{ url_for('notes_page') }}" class="font-medium hover:underline text-sm">Manage all notes &rarr;</a>
                            </div>
                        </div>

                        <div class="content-card p-6 flex flex-col">
                            <h3 class="flex items-center text-lg font-semibold tracking-wide">
                                {{ archive_box_heading_icon(classes='w-6 h-6 mr-3 brand-accent') }}
                                Imperial Treasury
                            </h3>
                            {% if stats and stats.total_items > 0 %}
                                <div class="space-y-3">
                                    <div>
                                        <p class="text-sm">Total Value</p>
                                        <p class="text-2xl font-bold brand-text">£{{ "%.2f"|format(stats.total_value or 0) }}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm">Total Items</p>
                                        <p class="text-2xl font-bold brand-text">{{ stats.total_items }}</p>
                                    </div>
                                </div>
                                <div class="mt-auto pt-4 flex items-center space-x-4">
                                     <a href="{{ url_for('collection_page') }}" class="font-medium hover:underline text-sm">View Collection</a>
                                     <a href="{{ url_for('collection_dashboard') }}" class="font-medium hover:underline text-sm">View Dashboard</a>
                                </div>
                            {% else %}
                                <p class="italic text-sm">Your collection is empty.</p>
                                 <div class="mt-auto pt-4">
                                     <a href="{{ url_for('add_collection_item') }}" class="font-medium hover:underline text-sm">Add an Item &rarr;</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endblock %}
        </main>
    </div>

    <script>
        const themeSwitcher = document.getElementById('theme-switcher');
        const htmlElement = document.documentElement;

        function setTheme(theme) {
            htmlElement.setAttribute('data-theme', theme);
            localStorage.setItem('byzantium-theme', theme);
            if (themeSwitcher.value !== theme) {
                themeSwitcher.value = theme;
            }
        }

        themeSwitcher.addEventListener('change', (event) => {
            setTheme(event.target.value);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('byzantium-theme') || 'byzantium';
            if (themeSwitcher.value !== savedTheme) {
                 themeSwitcher.value = savedTheme;
            }
            
            document.body.style.visibility = 'visible';
            
            const flashContainer = document.getElementById('flash-messages');
            if (flashContainer) {
                const messages = JSON.parse(flashContainer.getAttribute('data-messages') || '[]');
                if (messages && messages.length > 0) {
                    messages.forEach(msg => {
                        const [category, message] = msg;
                        createToast(message, category);
                    });
                }
            }

            const sidebar = document.querySelector('aside.sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarToggle) {
                const openSidebar = () => {
                    sidebar.classList.remove('-translate-x-full');
                    sidebarOverlay.classList.remove('hidden');
                };
                const closeSidebar = () => {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                };
                sidebarToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (sidebar.classList.contains('-translate-x-full')) openSidebar();
                    else closeSidebar();
                });
                sidebarOverlay.addEventListener('click', closeSidebar);
            }

            const pageTitleElement = document.getElementById('pageTitle');
            const activeLink = document.querySelector('.sidebar-link.active span');
            if (pageTitleElement && activeLink) {
                 pageTitleElement.textContent = activeLink.textContent;
            }

            // Task management logic
            const taskList = document.getElementById('task-list');
            const addTaskForm = document.getElementById('add-task-form');
            if(taskList && addTaskForm) {
                const newTaskTitleInput = document.getElementById('new-task-title');
                const newTaskDueDateInput = document.getElementById('new-task-due-date');

                taskList.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        const taskItem = e.target.closest('.task-item');
                        const taskId = taskItem.dataset.taskId;
                        const isCompleted = e.target.checked;
                        
                        fetch(`/api/task/${taskId}/status`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ is_completed: isCompleted })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (!data.success) {
                                createToast('Error updating task.', 'error');
                                e.target.checked = !isCompleted;
                            } else {
                                createToast('Task status updated.', 'success');
                                setTimeout(() => {
                                    if (isCompleted) taskItem.style.display = 'none';
                                }, 500);
                            }
                        })
                        .catch(() => {
                            createToast('Server error.', 'error');
                            e.target.checked = !isCompleted;
                        });
                    }
                });

                addTaskForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const title = newTaskTitleInput.value.trim();
                    const dueDate = newTaskDueDateInput.value;
                    if (!title) return;

                    const payload = { title: title };
                    if (dueDate) {
                        payload.due_date = dueDate;
                    }

                    fetch('/api/tasks', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    })
                    .then(response => {
                        if (response.ok) {
                            window.location.reload();
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            createToast(data.error, 'error');
                        }
                    })
                    .catch(() => createToast('Server error.', 'error'));
                });
            }
        });

        function createToast(message, category) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            const toast = document.createElement('div');
            toast.className = 'flex items-center p-4 text-white rounded-lg shadow-lg transition-all duration-300 transform translate-x-full opacity-0';
            let bgColor = 'bg-gray-700';
            if (category === 'success') bgColor = 'bg-green-600';
            if (category === 'error') bgColor = 'bg-red-600';
            if (category === 'info') bgColor = 'bg-blue-600';
            toast.classList.add(bgColor);
            toast.innerHTML = `<span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 100);
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-2');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>