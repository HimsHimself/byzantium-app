<!DOCTYPE html>
<html lang="en" data-theme="byzantium"> <!-- Default theme is set here -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byzantium Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%234B0082%22>â€ </text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- REMOVED: Cinzel font is no longer needed -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* NEW: THEME AND COLOR SYSTEM using CSS Variables */
        :root {
            /* Generic variable names */
            --color-background: #FDFDF6;
            --color-text-primary: #2d3748;
            --color-text-secondary: #4a5568;
            --color-text-muted: #94a3b8;
            --color-text-inverted: #ffffff;
            --color-surface: #ffffff;
            --color-border: #e2e8f0;
            --color-primary: #4B0082;
            --color-primary-hover: #3A006A;
            --color-primary-light: #f4f2f7;
            --color-secondary: #C59B08;
            --color-accent: #6d28d9;
            
            --font-heading: 'Inter', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        [data-theme="mass-effect"] {
            --color-background: #1a1a2e;
            --color-text-primary: #e0e0e0;
            --color-text-secondary: #b3b3b3;
            --color-text-muted: #7f7f7f;
            --color-text-inverted: #0d0d1f;
            --color-surface: #0d0d1f;
            --color-border: #3a3a5e;
            --color-primary: #ff6f61; /* N7 Red/Orange */
            --color-primary-hover: #e66054;
            --color-primary-light: #3a3a5e;
            --color-secondary: #00c2cb; /* Cyan accent */
            --color-accent: #ff6f61;
        }

        /* Base styles using the variables */
        body {
            font-family: var(--font-body);
            background-color: var(--color-background);
            color: var(--color-text-primary);
            /* NEW: More subtle background pattern */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e2e8f0' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sidebar {
            background-color: var(--color-surface);
            border-right: 1px solid var(--color-border);
        }

        .sidebar-link {
            color: var(--color-text-secondary);
            transition: all 0.2s ease-in-out;
            border-left: 4px solid transparent;
        }

        .sidebar-link:hover {
            color: var(--color-primary);
            background-color: var(--color-primary-light);
        }

        .sidebar-link.active {
            color: var(--color-primary);
            background-color: var(--color-primary-light);
            border-left-color: var(--color-secondary);
            font-weight: 600;
        }
        
        .header {
            background-color: color-mix(in srgb, var(--color-surface) 85%, transparent);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--color-border);
        }

        .brand-text { color: var(--color-primary); }
        .brand-accent { color: var(--color-secondary); }

        .content-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-top: 3px solid var(--color-primary);
            box-shadow: 0 5px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            border-radius: 0.75rem;
        }

        .content-card h3 {
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.75rem;
            margin-bottom: 1.25rem;
        }
        
        .form-input, .form-checkbox, .form-select, .form-textarea {
            background-color: color-mix(in srgb, var(--color-background) 50%, var(--color-surface) 50%);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            transition: all 0.2s ease-in-out;
        }

        .form-input:focus, .form-checkbox:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--color-primary) 20%, transparent);
            outline: none;
        }
        .form-checkbox:checked {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }

        .btn-primary {
            background-image: linear-gradient(to top right, var(--color-primary), var(--color-accent));
            color: var(--color-text-inverted);
            font-weight: 500;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px -1px rgba(0,0,0,.1);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 12px 0 color-mix(in srgb, var(--color-primary) 30%, transparent);
            transform: translateY(-2px);
        }
        
        .task-item label { transition: color 0.2s; }
        .task-item input:checked + label {
            text-decoration: line-through;
            color: var(--color-text-muted);
        }

        /* Specific overrides for Mass Effect theme */
        [data-theme="mass-effect"] .header {
             background-color: color-mix(in srgb, var(--color-surface) 85%, transparent);
        }
        [data-theme="mass-effect"] .form-input::placeholder {
            color: var(--color-text-muted);
        }
    </style>
</head>
<body class="flex h-screen antialiased">

    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3 w-80"></div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages" data-messages='{{ messages|tojson|safe }}' class="hidden"></div>
        {% endif %}
    {% endwith %}

    <aside class="sidebar w-64 space-y-2 py-4 px-2 fixed inset-y-0 left-0 transform md:translate-x-0 -translate-x-full transition-transform duration-200 ease-in-out z-30 shadow-lg">
        <div class="px-4 py-2 mb-4">
            <!-- REMOVED: .font-cinzel class -->
            <a href="{{ url_for('hello') }}" class="text-2xl font-bold brand-text">
                Byzantium <span class="brand-accent text-3xl align-middle">&dagger;</span>
            </a>
        </div>
        <nav>
            <a href="{{ url_for('hello') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if request.endpoint == 'hello' %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span>Dashboard</span>
            </a>
            <a href="{{ url_for('notes_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'notes_page' in request.endpoint or 'note' in request.endpoint %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <span>Notes</span>
            </a>
            <a href="{{ url_for('logs_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'log' in request.endpoint and 'food' not in request.endpoint %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                <span>Logs</span>
            </a>
            <a href="{{ url_for('oracle_chat_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if request.endpoint == 'oracle_chat_page' %}active{% endif %}">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                <span>Oracle Chat</span> </a>
            <a href="{{ url_for('add_food_log') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'food_log' in request.endpoint %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                <span>Food Log</span>
            </a>
            <a href="{{ url_for('collection_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'collection' in request.endpoint %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.375M9 12h6.375M9 17.25h6.375M12 3c-1.12 0-2.096.342-2.844.975-1.017.907-1.656 2.22-1.656 3.652v1.5c0 1.432.639 2.745 1.656 3.652C9.904 13.158 10.88 13.5 12 13.5s2.096-.342 2.844-.975c1.017-.907 1.656-2.22 1.656-3.652v-1.5c0-1.432-.639-2.745-1.656-3.652C14.096 3.342 13.12 3 12 3z"></path></svg>
                <span>Collection</span>
            </a>
            <a href="{{ url_for('view_activity_log') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if request.endpoint == 'view_activity_log' %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span>Activity Log</span>
            </a>
        </nav>
        <div class="absolute bottom-4 left-0 w-full px-4 space-y-4">
             <!-- NEW: Theme Switcher -->
            <div>
                <label for="theme-switcher" class="block text-xs font-medium text-slate-500 mb-1">Theme</label>
                <select id="theme-switcher" class="form-select w-full p-2 text-sm rounded-md">
                    <option value="byzantium">Byzantium</option>
                    <option value="mass-effect">Mass Effect</option>
                </select>
            </div>
             <a href="{{ url_for('logout') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md w-full text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <div class="flex-1 flex flex-col md:ml-64">
        <header class="header p-4 shadow-sm sticky top-0 z-10">
            <div class="flex justify-between items-center">
                <button id="sidebarToggle" class="md:hidden text-slate-600 hover:text-purple-700 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <!-- REMOVED: .font-cinzel class -->
                <h1 id="pageTitle" class="text-xl font-semibold text-slate-700 tracking-wider">Dashboard</h1>
                <div class="w-6"></div> 
            </div>
        </header>

        <main class="flex-1 p-6 md:p-8 overflow-y-auto">
            {% block content %}
            <div class="space-y-8">
                <!-- REMOVED: Inline style -->
                <div class="p-6 rounded-lg btn-primary">
                    <!-- REMOVED: .font-cinzel class -->
                    <h2 class="text-2xl lg:text-3xl font-bold text-white">Your Imperial Dashboard</h2>
                    <p class="text-purple-200 mt-1 text-sm lg:text-base">A summary of your personal archives and daily logs.</p>
                </div>
            
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
                    <div class="content-card p-6 flex flex-col lg:col-span-2 min-h-[450px]">
                        <!-- REMOVED: .font-cinzel class -->
                        <h3 class="flex items-center text-lg font-semibold text-slate-700 tracking-wide">
                            <svg class="w-6 h-6 mr-3 brand-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Tasks
                        </h3>
                        <div id="task-list" class="space-y-1 flex-grow">
                            {% if tasks %}
                                {% for task in tasks %}
                                <div class="task-item flex items-center justify-between py-2" data-task-id="{{ task.id }}">
                                    <div class="flex items-center">
                                        <input id="task-{{ task.id }}" type="checkbox" class="form-checkbox h-5 w-5 rounded text-purple-600 focus:ring-purple-500" {% if task.is_completed %}checked{% endif %}>
                                        <label for="task-{{ task.id }}" class="ml-3 text-sm font-medium">{{ task.title }}</label>
                                    </div>
                                    {% if task.due_date %}
                                        <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full whitespace-nowrap">{{ task.due_date.strftime('%d %b, %H:%M') }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% else %}
                                <p id="no-tasks-msg" class="text-slate-500 italic text-sm">No outstanding tasks. Well done!</p>
                            {% endif %}
                        </div>
                        <form id="add-task-form" class="mt-auto flex flex-col gap-2 pt-4 border-t border-slate-200">
                            <div class="flex gap-2">
                                <input type="text" id="new-task-title" placeholder="Add a new task..." class="form-input flex-grow p-2 text-sm rounded-md">
                                <button type="submit" class="btn-primary text-sm font-semibold px-4 py-2 rounded-md shrink-0">Add</button>
                            </div>
                            <input type="datetime-local" id="new-task-due-date" title="Set an optional due date" class="form-input p-2 text-sm rounded-md w-full">
                        </form>
                    </div>

                    <div class="lg:col-span-1 space-y-8">
                        <div class="content-card p-6 flex flex-col">
                            <h3 class="flex items-center text-lg font-semibold text-slate-700 tracking-wide">
                                <svg class="w-6 h-6 mr-3 brand-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                                Scribe's Desk
                            </h3>
                            {% if recent_notes %}
                                <ul class="space-y-2">
                                    {% for note in recent_notes %}
                                        <li class="flex justify-between items-baseline">
                                            <a href="{{ url_for('view_note', note_id=note.id) }}" class="hover:text-purple-700 truncate" title="{{ note.title }}">{{ note.title }}</a>
                                            <span class="text-xs text-slate-400 flex-shrink-0 ml-2">{{ note.updated_at.strftime('%d %b') }}</span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-slate-500 italic text-sm">No notes found.</p>
                            {% endif %}
                            <div class="mt-auto pt-4">
                                <a href="{{ url_for('notes_page') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline text-sm">Manage all notes &rarr;</a>
                            </div>
                        </div>

                        <div class="content-card p-6 flex flex-col">
                            <h3 class="flex items-center text-lg font-semibold text-slate-700 tracking-wide">
                                <svg class="w-6 h-6 mr-3 brand-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 0a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9m12 0V6a3 3 0 00-3-3H9a3 3 0 00-3 3v3" /></svg>
                                Imperial Treasury
                            </h3>
                            {% if stats and stats.total_items > 0 %}
                                <div class="space-y-3">
                                    <div>
                                        <p class="text-sm text-slate-500">Total Value</p>
                                        <p class="text-2xl font-bold brand-text">Â£{{ "%.2f"|format(stats.total_value or 0) }}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-slate-500">Total Items</p>
                                        <p class="text-2xl font-bold brand-text">{{ stats.total_items }}</p>
                                    </div>
                                </div>
                                <div class="mt-auto pt-4 flex items-center space-x-4">
                                     <a href="{{ url_for('collection_page') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline text-sm">View Collection</a>
                                     <a href="{{ url_for('collection_dashboard') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline text-sm">View Dashboard</a>
                                </div>
                            {% else %}
                                <p class="text-slate-500 italic text-sm">Your collection is empty.</p>
                                 <div class="mt-auto pt-4">
                                     <a href="{{ url_for('add_collection_item') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline text-sm">Add an Item &rarr;</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endblock %}
        </main>
    </div>

    <script>
        // --- NEW: Theme Management ---
        const themeSwitcher = document.getElementById('theme-switcher');
        const htmlElement = document.documentElement;

        function setTheme(theme) {
            htmlElement.setAttribute('data-theme', theme);
            localStorage.setItem('byzantium-theme', theme);
            if (themeSwitcher.value !== theme) {
                themeSwitcher.value = theme;
            }
        }

        themeSwitcher.addEventListener('change', (event) => {
            setTheme(event.target.value);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('byzantium-theme') || 'byzantium';
            setTheme(savedTheme);
            
            // --- Existing JS, unmodified below this line ---
            
            const flashContainer = document.getElementById('flash-messages');
            if (flashContainer) {
                const messages = JSON.parse(flashContainer.getAttribute('data-messages') || '[]');
                if (messages && messages.length > 0) {
                    messages.forEach(msg => {
                        const [category, message] = msg;
                        createToast(message, category);
                    });
                }
            }

            const sidebar = document.querySelector('aside.sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarToggle) {
                const openSidebar = () => {
                    sidebar.classList.remove('-translate-x-full');
                    sidebarOverlay.classList.remove('hidden');
                };
                const closeSidebar = () => {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                };
                sidebarToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (sidebar.classList.contains('-translate-x-full')) openSidebar();
                    else closeSidebar();
                });
                sidebarOverlay.addEventListener('click', closeSidebar);
            }

            const pageTitleElement = document.getElementById('pageTitle');
            const activeLink = document.querySelector('.sidebar-link.active span');
            if (pageTitleElement && activeLink) {
                 pageTitleElement.textContent = activeLink.textContent;
            }

            // --- Task Management Logic ---
            const taskList = document.getElementById('task-list');
            const addTaskForm = document.getElementById('add-task-form');
            const newTaskTitleInput = document.getElementById('new-task-title');
            const newTaskDueDateInput = document.getElementById('new-task-due-date');
            
            if (taskList && addTaskForm) {
                // Update task status
                taskList.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        const taskItem = e.target.closest('.task-item');
                        const taskId = taskItem.dataset.taskId;
                        const isCompleted = e.target.checked;
                        
                        fetch(`/api/task/${taskId}/status`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ is_completed: isCompleted })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (!data.success) {
                                createToast('Error updating task.', 'error');
                                e.target.checked = !isCompleted; // Revert checkbox on failure
                            } else {
                                createToast('Task status updated.', 'success');
                                // Optionally hide the task after a delay
                                setTimeout(() => {
                                    if (isCompleted) taskItem.style.display = 'none';
                                }, 500);
                            }
                        })
                        .catch(() => {
                            createToast('Server error.', 'error');
                            e.target.checked = !isCompleted;
                        });
                    }
                });

                // Add new task
                addTaskForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const title = newTaskTitleInput.value.trim();
                    const dueDate = newTaskDueDateInput.value;
                    if (!title) return;

                    const payload = { title: title };
                    if (dueDate) {
                        payload.due_date = dueDate;
                    }

                    fetch('/api/tasks', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    })
                    .then(response => {
                        if (response.ok) {
                             // Reload the page on success to get the correctly sorted list
                            window.location.reload();
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            createToast(data.error, 'error');
                        }
                    })
                    .catch(() => createToast('Server error.', 'error'));
                });
            }
        });

        function createToast(message, category) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            const toast = document.createElement('div');
            toast.className = 'flex items-center p-4 text-white rounded-lg shadow-lg transition-all duration-300 transform translate-x-full opacity-0';
            let bgColor = 'bg-gray-700';
            if (category === 'success') bgColor = 'bg-green-600';
            if (category === 'error') bgColor = 'bg-red-600';
            if (category === 'info') bgColor = 'bg-blue-600';
            toast.classList.add(bgColor);
            toast.innerHTML = `<span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 100);
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-2');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }
    </script>
</body>
</html>