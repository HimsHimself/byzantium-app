<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byzantium Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%234B0082%22>†</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --imperial-purple: #4B0082;
            --imperial-purple-dark: #3A006A;
            --byzantine-gold: #C59B08;
            --byzantine-ivory: #FDFDF6;
            --byzantine-slate: #2d3748;
            --byzantine-border: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--byzantine-ivory);
            color: var(--byzantine-slate);
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23e2e8f0' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M0 0h20v1H0zM10 2v18h1V2z'/%3E%3C/g%3E%3C/svg%3E");
        }

        .sidebar {
            background-color: #ffffff;
            border-right: 1px solid var(--byzantine-border);
        }

        .sidebar-link {
            color: #4a5568;
            transition: all 0.2s ease-in-out;
            border-left: 4px solid transparent;
        }

        .sidebar-link:hover {
            color: var(--imperial-purple);
            background-color: #f4f2f7;
        }

        .sidebar-link.active {
            color: var(--imperial-purple);
            background-color: #f4f2f7;
            border-left-color: var(--byzantine-gold);
            font-weight: 600;
        }

        .header {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--byzantine-border);
        }

        .byzantine-gold { color: var(--byzantine-gold); }
        .byzantine-purple-text { color: var(--imperial-purple); }

        .content-card {
            background-color: #ffffff;
            border: 1px solid var(--byzantine-border);
            border-top: 3px solid var(--imperial-purple);
            box-shadow: 0 5px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            border-radius: 0.75rem;
        }
        
        .form-input {
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            color: var(--byzantine-slate);
            transition: all 0.2s ease-in-out;
        }

        .form-input:focus {
            border-color: var(--imperial-purple);
            box-shadow: 0 0 0 2px rgba(75, 0, 130, 0.2);
            outline: none;
        }

        .btn-primary {
            background-image: linear-gradient(to top right, var(--imperial-purple), #6d28d9);
            color: #ffffff;
            font-weight: 500;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px -1px rgba(0,0,0,.1);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 12px 0 rgba(75, 0, 130, 0.3);
            transform: translateY(-2px);
        }

    </style>
</head>
<body class="flex h-screen antialiased">

    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3 w-80"></div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages" data-messages='{{ messages|tojson|safe }}' class="hidden"></div>
        {% endif %}
    {% endwith %}

    <aside class="sidebar w-64 space-y-2 py-4 px-2 fixed inset-y-0 left-0 transform md:translate-x-0 -translate-x-full transition-transform duration-200 ease-in-out z-30 shadow-lg">
        <div class="px-4 py-2 mb-4">
            <a href="{{ url_for('hello') }}" class="text-2xl font-bold byzantine-purple-text">
                Byzantium <span class="byzantine-gold text-3xl align-middle">&dagger;</span>
            </a>
        </div>
        <nav>
            <a href="{{ url_for('hello') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if request.endpoint == 'hello' %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span>Dashboard</span>
            </a>
            <a href="{{ url_for('notes_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'notes_page' in request.endpoint or 'note' in request.endpoint %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <span>Notes</span>
            </a>
            <a href="{{ url_for('oracle_chat_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if request.endpoint == 'oracle_chat_page' %}active{% endif %}">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                <span>Oracle Chat</span> </a>
            <a href="{{ url_for('food_log_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'food_log' in request.endpoint %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                <span>Food Log</span>
            </a>
            <a href="{{ url_for('collection_page') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if 'collection' in request.endpoint %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.375M9 12h6.375M9 17.25h6.375M12 3c-1.12 0-2.096.342-2.844.975-1.017.907-1.656 2.22-1.656 3.652v1.5c0 1.432.639 2.745 1.656 3.652C9.904 13.158 10.88 13.5 12 13.5s2.096-.342 2.844-.975c1.017-.907 1.656-2.22 1.656-3.652v-1.5c0-1.432-.639-2.745-1.656-3.652C14.096 3.342 13.12 3 12 3z"></path></svg>
                <span>Collection</span>
            </a>
            <a href="{{ url_for('view_activity_log') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md {% if request.endpoint == 'view_activity_log' %}active{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span>Activity Log</span>
            </a>
        </nav>
        <div class="absolute bottom-0 left-0 w-full p-4">
             <a href="{{ url_for('logout') }}" class="sidebar-link flex items-center space-x-3 py-3 px-4 rounded-md w-full text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <div class="flex-1 flex flex-col md:ml-64">
        <header class="header p-4 shadow-sm sticky top-0 z-10">
            <div class="flex justify-between items-center">
                <button id="sidebarToggle" class="md:hidden text-slate-600 hover:text-purple-700 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 id="pageTitle" class="text-xl font-semibold text-slate-700">Dashboard</h1>
                <div class="w-6"></div> 
            </div>
        </header>

        <main class="flex-1 p-6 md:p-8 overflow-y-auto">
            {% block content %}
            <div class="space-y-8">
                <div class="p-6 rounded-lg" style="background-image: linear-gradient(to top right, var(--imperial-purple), #6d28d9);">
                    <h2 class="text-3xl font-bold text-white">Your Imperial Dashboard</h2>
                    <p class="text-purple-200 mt-1">A summary of your personal archives and daily logs.</p>
                </div>
            
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            
                    <div class="content-card p-6 flex flex-col">
                        <h3 class="flex items-center text-lg font-semibold text-slate-700 mb-4">
                            <svg class="w-6 h-6 mr-3 byzantine-gold" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 0a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9m12 0V6a3 3 0 00-3-3H9a3 3 0 00-3 3v3" /></svg>
                            Imperial Treasury
                        </h3>
                        {% if stats and stats.total_items > 0 %}
                            <div class="space-y-3">
                                <div>
                                    <p class="text-sm text-slate-500">Total Value</p>
                                    <p class="text-2xl font-bold byzantine-purple-text">£{{ "%.2f"|format(stats.total_value or 0) }}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-slate-500">Total Items</p>
                                    <p class="text-2xl font-bold byzantine-purple-text">{{ stats.total_items }}</p>
                                </div>
                            </div>
                            <div class="mt-auto pt-4 flex items-center space-x-4">
                                 <a href="{{ url_for('collection_page') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline text-sm">View Collection</a>
                                 <a href="{{ url_for('collection_dashboard') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline text-sm">View Dashboard</a>
                            </div>
                        {% else %}
                            <p class="text-slate-500 italic text-sm">Your collection is empty. Add your first item to see a summary here.</p>
                             <div class="mt-auto pt-4">
                                 <a href="{{ url_for('add_collection_item') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline text-sm">Add an Item &rarr;</a>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="content-card p-6 flex flex-col">
                        <h3 class="flex items-center text-lg font-semibold text-slate-700 mb-4">
                            <svg class="w-6 h-6 mr-3 byzantine-gold" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                            Scribe's Desk
                        </h3>
                        {% if recent_notes %}
                            <ul class="space-y-2">
                                {% for note in recent_notes %}
                                    <li class="flex justify-between items-baseline">
                                        <a href="{{ url_for('view_note', note_id=note.id) }}" class="text-slate-800 hover:text-purple-700 truncate" title="{{ note.title }}">
                                            {{ note.title }}
                                        </a>
                                        <span class="text-xs text-slate-400 flex-shrink-0 ml-2">{{ note.updated_at.strftime('%d %b') }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-slate-500 italic text-sm">No notes found.</p>
                        {% endif %}
                        <div class="mt-auto pt-4">
                            <a href="{{ url_for('notes_page') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline text-sm">Manage all notes &rarr;</a>
                        </div>
                    </div>
                    
                    <div class="content-card p-6 flex flex-col">
                        <h3 class="flex items-center text-lg font-semibold text-slate-700 mb-4">
                             <svg class="w-6 h-6 mr-3 byzantine-gold" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 9.75v.015m0 0v2.235a2.25 2.25 0 01-.632 1.506l-4.14 4.141a2.251 2.251 0 01-1.588.659H6.321a2.25 2.25 0 01-1.588-.66L.64 13.5a2.25 2.25 0 01-.64-1.506v-2.235a2.25 2.25 0 01.632-1.506l4.14-4.141a2.251 2.251 0 011.588-.659h8.232a2.25 2.25 0 011.588.66l4.142 4.14a2.25 2.25 0 01.632 1.506z" /></svg>
                            Daily Sustenance
                        </h3>
                        <div>
                             <p class="text-sm text-slate-500">Calories Logged Today</p>
                             <p class="text-2xl font-bold byzantine-purple-text">{{ "%.0f"|format(calories_today) }} <span class="text-lg font-medium text-slate-400">/ 2000 kcal</span></p>
                        </div>
                        <div class="mt-auto pt-4">
                            <a href="{{ url_for('food_log_page') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline text-sm">Log more food &rarr;</a>
                        </div>
                    </div>
                    
                    <div class="content-card p-6">
                        <h3 class="flex items-center text-lg font-semibold text-slate-700 mb-4">
                            <svg class="w-6 h-6 mr-3 byzantine-gold" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                            Quick Actions
                        </h3>
                        <ul class="space-y-3">
                            <li><a href="{{ url_for('add_collection_item') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline">Add New Item to Treasury</a></li>
                            <li><a href="{{ url_for('oracle_chat_page') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline">Consult the Oracle</a></li>
                            <li><a href="{{ url_for('view_food_log') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline">View Food Log History</a></li>
                        </ul>
                    </div>
                    
                    <div class="content-card p-6 lg:col-span-2">
                        <h3 class="flex items-center text-lg font-semibold text-slate-700 mb-4">
                             <svg class="w-6 h-6 mr-3 byzantine-gold" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                            Palace Ledger
                        </h3>
                         {% if recent_activities %}
                            <ul class="space-y-2 text-sm">
                                {% for activity in recent_activities %}
                                    <li class="flex justify-between items-baseline bg-slate-50 p-2 rounded-md">
                                        <p class="text-slate-600">
                                            Action: <span class="font-semibold text-slate-800">{{ activity.activity_type.replace('_', ' ') | title }}</span>
                                        </p>
                                        <span class="text-xs text-slate-400 flex-shrink-0 ml-2">{{ activity.timestamp.strftime('%H:%M:%S') }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-slate-500 italic text-sm">No recent activity recorded.</p>
                        {% endif %}
                         <div class="mt-auto pt-4">
                            <a href="{{ url_for('view_activity_log') }}" class="font-medium text-purple-600 hover:text-purple-800 hover:underline text-sm">View full log &rarr;</a>
                        </div>
                    </div>
                </div>
            </div>
            {% endblock %}
        </main>
    </div>

    <script>
        // --- Toast Notification Logic ---
        function createToast(message, category) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = 'flex items-center p-4 text-white rounded-lg shadow-lg transition-all duration-300 transform translate-x-full opacity-0';
            
            let bgColor = 'bg-gray-700'; // Default
            if (category === 'success') bgColor = 'bg-green-600';
            if (category === 'error') bgColor = 'bg-red-600';
            if (category === 'info') bgColor = 'bg-blue-600';
            
            toast.classList.add(bgColor);
            toast.innerHTML = `<span>${message}</span>`;
            toastContainer.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 100);

            // Animate out and remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-2');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- Process flashed messages into toasts on page load ---
            const flashContainer = document.getElementById('flash-messages');
            if (flashContainer) {
                // Parse the JSON data from the data attribute
                const messages = JSON.parse(flashContainer.getAttribute('data-messages') || '[]');
                if (messages && messages.length > 0) {
                    messages.forEach(msg => {
                        // The flashed message from Flask is an array: [category, message]
                        if (Array.isArray(msg) && msg.length === 2) {
                            const [category, message] = msg;
                            createToast(message, category);
                        }
                    });
                }
            }

            // --- Mobile Sidebar Logic ---
            const sidebar = document.querySelector('aside.sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (sidebarToggle) {
                const openSidebar = () => {
                    sidebar.classList.remove('-translate-x-full');
                    sidebarOverlay.classList.remove('hidden');
                };
                const closeSidebar = () => {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                };
                sidebarToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (sidebar.classList.contains('-translate-x-full')) openSidebar();
                    else closeSidebar();
                });
                sidebarOverlay.addEventListener('click', closeSidebar);
            }

            // --- Dynamic Page Title Logic ---
            const pageTitleElement = document.getElementById('pageTitle');
            const activeLink = document.querySelector('.sidebar-link.active span');
            if (pageTitleElement) {
                 if (activeLink) {
                    pageTitleElement.textContent = activeLink.textContent;
                } else {
                    // Fallback for pages without an active link in the main nav
                    if (window.location.pathname.includes('/notes') || window.location.pathname.includes('/note/')) {
                        pageTitleElement.textContent = "Notes";
                    }
                }
            }
        });
    </script>
</body>
</html>