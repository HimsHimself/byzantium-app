{% extends "index.html" %}
{% import '_macros.html' as macros with context %}

{% block content %}
<div class="space-y-6">
    {# Floating Header with Title and Totals #}
    <div class="sticky top-[-32px] bg-opacity-80 backdrop-blur-sm z-10 -mx-8 -mt-8 px-8 pt-8 pb-4 bg-[var(--color-background)] border-b" style="border-color: var(--color-border);">
        <div class="flex justify-between items-center">
            <h1 id="pageTitle" class="text-2xl font-bold tracking-wider">Food Log</h1>
            <div class="flex items-center gap-6">
                <div>
                    <div class="text-xs uppercase font-semibold text-right" style="color: var(--color-text-secondary);">Today's Total</div>
                    <div class="text-2xl font-bold" style="color: var(--color-primary);">{{ today_total|int }} <span class="text-base font-medium" style="color: var(--color-text-secondary);">kcal</span></div>
                </div>
                <a href="{{ url_for('add_food_log') }}" class="btn-primary text-sm font-semibold px-4 py-2 rounded-md shrink-0">Add Entry</a>
            </div>
        </div>
    </div>

    {# Chart Display #}
    {% if chart_url %}
    <div class="content-card p-4">
        <img src="data:image/png;base64,{{ chart_url }}" alt="Column chart of total calories for the last 30 days" class="w-full h-auto">
    </div>
    {% endif %}

    {# Search and Filter Bar #}
    <div class="content-card p-4">
        <form method="GET" action="{{ url_for('view_food_log') }}">
            <label for="q" class="block text-sm font-medium text-slate-600 mb-1">Search Food Log</label>
            <div class="flex">
                <input type="text" name="q" id="q" value="{{ search_query or '' }}" placeholder="Search for a specific food..." class="form-input block w-full p-2 rounded-l-md">
                <button type="submit" class="btn-primary px-4 rounded-r-md">Search</button>
            </div>
        </form>
    </div>

    {# Loop for Daily Log Cards #}
    {% if logs_by_date %}
        <div class="space-y-8">
            {% for date, data in logs_by_date.items() %}
                <div class="content-card p-0 overflow-hidden">
                    {# Daily Header - NOW STICKY #}
                    <div class="sticky top-16 flex justify-between items-center p-4 border-b z-[5]" style="background-color: var(--color-surface); border-color: var(--color-border);">
                        <h3 class="font-bold text-slate-800">{{ date.strftime('%A, %d %B %Y') }}</h3>
                        <p class="font-bold text-slate-800">Total: {{ data.daily_total|int }} kcal</p>
                    </div>

                    {# Table for the day's logs #}
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <tbody class="divide-y" style="border-color: var(--color-border);">
                                {% for log in data.logs %}
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap" style="vertical-align: top; width: 1%;">
                                        <div class="font-medium" style="color: var(--color-text-primary);">{{ log.log_type }}</div>
                                        <div style="color: var(--color-text-secondary);">{{ log.log_time.strftime('%H:%M') }}</div>
                                    </td>
                                    <td class="px-4 py-3" style="color: var(--color-text-primary); vertical-align: top;">
                                        {{ log.description }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right font-semibold" style="color: var(--color-text-primary); vertical-align: top; width: 1%;">
                                        {{ log.calories or 'N/A' }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right font-medium" style="color: var(--color-primary); vertical-align: top; width: 1%;">
                                        <a href="{{ url_for('edit_food_log', log_id=log.id) }}" class="font-semibold">Edit</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="content-card p-10 text-center text-sm" style="color: var(--color-text-secondary);">
             {% if search_query %}
                No food log entries found matching your search. Try another term.
            {% else %}
                No food log entries found for the last 30 days.
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const pageTitleElement = document.getElementById('pageTitle');
    if (pageTitleElement && pageTitleElement.textContent !== "Food Log") {
         pageTitleElement.textContent = "Food Log";
    }
    document.title = "Byzantium | Food Log";
});
</script>
{% endblock %}